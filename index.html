<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SärmäysPro - VAMM Steel</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { 
            --vamm-yellow: #fecb00; 
            --bg: #000000;
            --card: #1a1a1a;
            --text: #ffffff;
        }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        
        .version-header { color: var(--vamm-yellow); font-weight: 900; font-size: 0.8rem; text-align: center; margin-bottom: 5px; }
        
        .logo-box { text-align: center; padding: 10px 0; border-bottom: 2px solid var(--vamm-yellow); margin-bottom: 15px; }
        .logo-vamm { font-weight: 900; font-size: 1.8rem; color: var(--vamm-yellow); }
        .logo-steel { font-weight: 300; font-size: 1.8rem; color: #fff; }

        .card { background: var(--card); padding: 20px; border-radius: 15px; margin-bottom: 10px; text-align: center; border: 1px solid #333; }
        .timer-val { font-size: 4.5rem; font-family: monospace; color: var(--vamm-yellow); font-weight: 900; margin: 5px 0; line-height: 1; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; }
        .stat-item { background: #000; padding: 10px 2px; border-radius: 10px; border: 1px solid #222; }
        .stat-nro { font-size: 1.2rem; font-weight: 900; display: block; }
        .stat-txt { font-size: 0.6rem; color: #888; text-transform: uppercase; }

        .btn-large { border: none; border-radius: 12px; font-weight: 900; font-size: 1.2rem; height: 70px; width: 100%; cursor: pointer; text-transform: uppercase; margin-bottom: 8px; }
        .btn-start { background: var(--vamm-yellow); color: #000; }
        .btn-stop { background: #ce1126; color: #fff; }

        input { width: 100%; padding: 15px; background: #000; border: 1px solid #444; border-radius: 10px; color: #fff; font-size: 1.2rem; margin-bottom: 8px; text-align: center; }
        
        #scanner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; display: none; flex-direction: column; }
        #reader { width: 100% !important; flex: 1; }

        .log-item { display: flex; justify-content: space-between; padding: 12px; background: #111; margin-top: 4px; border-radius: 8px; border-left: 4px solid var(--vamm-yellow); font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="version-header">VERSION v5.4.1</div>
    
    <div class="logo-box">
        <span class="logo-vamm">VAMM</span><span class="logo-steel">STEEL</span>
    </div>

    <div class="card">
        <div id="kello" class="timer-val">00:00:00</div>
        <div class="stats-grid">
            <div class="stat-item"><span id="eff_nyt" class="stat-nro">0.00</span><span class="stat-txt">EFF</span></div>
            <div class="stat-item"><span id="min_nyt" class="stat-nro">0</span><span class="stat-txt">MIN</span></div>
            <div class="stat-item" onclick="naytaArkisto()"><span id="eff_jakso" class="stat-nro" style="color:var(--vamm-yellow)">0.00</span><span class="stat-txt">JAKSO</span></div>
        </div>
    </div>

    <button id="mainBtn" class="btn-large btn-start" onclick="hallitseVuoroa()">ALOITA VUORO</button>

    <div id="inputArea" style="display:none">
        <input type="text" id="in_id" placeholder="TYÖNUMERO (Skannaa)" readonly onclick="startScan('in_id')">
        <input type="text" id="in_laji" placeholder="LAJIMERKKI (Skannaa)" readonly onclick="startScan('in_laji')">
        <div class="stats-grid">
            <input type="number" id="in_s" placeholder="ASET" oninput="tarkistaTallennus()">
            <input type="number" id="in_t" placeholder="TAIV" oninput="tarkistaTallennus()">
            <input type="number" id="in_m" placeholder="MUUT" oninput="tarkistaTallennus()">
        </div>
    </div>

    <div id="lista"></div>
</div>

<div id="scanner-overlay">
    <div id="reader"></div>
    <button class="btn-large btn-stop" style="border-radius:0;" onclick="stopScan()">SULJE SKANNERI</button>
</div>

<div id="arkistoRuutu" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:1000; display:none; padding:20px; overflow-y:auto;">
    <button onclick="suljeArkisto()" style="float:right; color:white; background:none; border:none; font-size:2.5rem">✕</button>
    <h2 style="color:var(--vamm-yellow)">HISTORIA</h2>
    <div id="arkistoSisältö"></div>
    <button onclick="nollaaKaikki()" class="btn-large btn-stop" style="margin-top:20px">NOLLAA JAKSO HISTORIA</button>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('vamm_v14_data')) || { active: false, start: 0, log: [] };
    let arch = JSON.parse(localStorage.getItem('vamm_v14_arch')) || [];
    let scanner = null;

    function save() {
        localStorage.setItem('vamm_v14_data', JSON.stringify(db));
        localStorage.setItem('vamm_v14_arch', JSON.stringify(arch));
    }

    function playBeep() {
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            osc.connect(ctx.destination);
            osc.frequency.value = 880;
            osc.start();
            osc.stop(ctx.currentTime + 0.1);
        } catch(e) {}
    }

    function hallitseVuoroa() {
        if (!db.active) {
            let t = prompt("Aloitusaika (HH:MM):", new Date().toLocaleTimeString('fi-FI',{hour:'2-digit',minute:'2-digit'}));
            if(!t) return;
            let [h, m] = t.split(':');
            let d = new Date(); d.setHours(h, m, 0, 0);
            db.start = d.getTime();
            db.active = true;
            db.log = [];
            playBeep();
        } else {
            if(confirm("Lopetetaanko vuoro?")) {
                db.log.forEach(x => arch.push(x));
                db.active = false;
                db.start = 0;
            }
        }
        save();
        paivitaUI();
    }

    function startScan(targetId) {
        document.getElementById('scanner-overlay').style.display = 'flex';
        scanner = new Html5Qrcode("reader");
        const config = { fps: 20, qrbox: { width: 300, height: 120 } };
        
        scanner.start({ facingMode: "environment" }, config, (text) => {
            document.getElementById(targetId).value = text.trim();
            stopScan();
        }).catch(() => {});
    }

    function stopScan() {
        if(scanner) {
            scanner.stop().then(() => {
                document.getElementById('scanner-overlay').style.display = 'none';
                scanner = null;
            });
        }
    }

    function tarkistaTallennus() {
        const id = document.getElementById('in_id').value;
        const laji = document.getElementById('in_laji').value;
        const s = document.getElementById('in_s').value;
        const t = document.getElementById('in_t').value;
        const m = document.getElementById('in_m').value || 0;

        if (id.length >= 3 && laji && s !== "" && t !== "") {
            db.log.push({ id, laji, s: Number(s), t: Number(t), m: Number(m) });
            ['in_id','in_laji','in_s','in_t','in_m'].forEach(k => document.getElementById(k).value = "");
            save();
            renderLista();
        }
    }

    function pyoraKello() {
        if (db.active

            
