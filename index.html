<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S√§rm√§ys Pro v4.0.0</title>
    <style>
        .version-tag { color: #ff8c00; font-weight: bold; padding: 10px; font-size: 0.8rem; text-align: center; }
        body { font-family: sans-serif; padding: 10px; background: #f0f2f5; margin: 0; color: #333; }
        .mittari-alue { display: flex; justify-content: space-around; background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .mittari-arvo { font-family: monospace; font-size: 1.4rem; font-weight: bold; color: #007bff; }
        input, button { width: 100%; padding: 15px; font-size: 1.1rem; border-radius: 12px; border: 2px solid #ddd; margin-bottom: 8px; box-sizing: border-box; }
        .btn-aloita { background: #28a745; color: white; border: none; }
        .btn-tallenna { background: #007bff; color: white; border: none; }
        .btn-lopeta { background: #dc3545; color: white; border: none; margin-top: 20px; }
        #raportti-alue { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; overflow-y: auto; padding: 20px; }
    </style>
</head>
<body onload="tarkistaTila()">
    <div class="version-tag">Versio 4.0.0 üü†</div>

    <div class="mittari-alue">
        <div><div>Vuoro</div><div id="v-jout" class="mittari-arvo">0.00</div></div>
        <div><div>Jakso</div><div id="j-jout" class="mittari-arvo">0.00</div></div>
    </div>

    <div id="kello" style="font-size: 2.2rem; text-align: center; font-family: monospace; margin: 15px 0;">00:00:00</div>

    <div id="aloitus-paneeli">
        <label>Vuoron aloitusaika:</label>
        <input type="time" id="aloitus-kello">
        <button class="btn-aloita" onclick="aloitaVuoro()">ALOITA TY√ñVUORO üöÄ</button>
    </div>

    <div id="tyo-alue" style="display:none;">
        <button style="background:#6c757d; color:white; border:none;" onclick="naytaRaportti()">RAPORTTI üìä</button>
        
        <div id="skannaus">
            <input type="number" id="id-input" placeholder="Skannaa ID (6 numeroa)" oninput="tarkistaId(this.value)">
            <input type="text" id="laji-input" placeholder="LAJIMERKKI" style="display:none; text-transform: uppercase;" oninput="this.value = this.value.toUpperCase(); tallennaLuonnos()" onkeypress="lajiEnter(event)">
        </div>

        <div id="vaiheet" style="display:none; background: white; padding: 15px; border-radius: 12px; margin-top:10px;">
            <label>Asetusaika (min):</label>
            <input type="number" id="a-aika" oninput="tallennaLuonnos()">
            <label>Taivutusaika (min.sek):</label>
            <input type="number" step="0.01" id="t-aika" oninput="tallennaLuonnos()">
            <hr>
            <label>Muu vaihe (Nimi):</label>
            <input type="text" id="m-nimi" placeholder="Esim. HIONTA" oninput="this.value = this.value.toUpperCase(); tallennaLuonnos()">
            <label>Muu aika (min.sek):</label>
            <input type="number" step="0.01" id="m-aika" oninput="tallennaLuonnos()">
            <button class="btn-tallenna" onclick="tallennaKortti()">TALLENNA KORTTI ‚úÖ</button>
        </div>

        <button class="btn-lopeta" onclick="lopetaVuoro()">LOPETA VUORO üèÅ</button>
    </div>

    <div id="raportti-alue">
        <h2>Raportti</h2>
        <div id="raportti-sisalto"></div>
        <button onclick="suljeRaportti()">SULJE</button>
        <button style="background:#ffc107; margin-top:30px;" onclick="nollaaKaikki()">NOLLAA JAKSO ‚ö†Ô∏è</button>
    </div>

<script>
    let d = { aloitus: null, kortit: [], tavoite: 0 };
    let jakso = JSON.parse(localStorage.getItem('sarmaysJakso')) || { min: 0, sek: 0 };

    function soita() { new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play().catch(()=>{}); }

    function aloitaVuoro() {
        let kelloVal = document.getElementById('aloitus-kello').value;
        if(!kelloVal) { alert("Aseta aloitusaika!"); return; }
        soita();
        d.aloitus = Date.now();
        document.getElementById('aloitus-paneeli').style.display = "none";
        document.getElementById('tyo-alue').style.display = "block";
        setInterval(paivita, 1000);
        tallennaLuonnos();
    }

    function tarkistaId(v) {
        if(v.length === 6) {
            soita();
            document.getElementById('id-input').disabled = true;
            document.getElementById('laji-input').style.display = "block";
            document.getElementById('laji-input').focus();
            tallennaLuonnos();
        }
    }

    function lajiEnter(e) {
        if(e.key === 'Enter') {
            soita();
            document.getElementById('skannaus').style.display = "none";
            document.getElementById('vaiheet').style.display = "block";
            tallennaLuonnos();
        }
    }

    function muunna(v) {
        let s = v.toString().split('.');
        return (parseInt(s[0])||0) + ((parseInt(s[1])||0)/60);
    }

    function tallennaKortti() {
        let t = parseFloat(document.getElementById('a-aika').value||0) + muunna(document.getElementById('t-aika').value) + muunna(document.getElementById('m-aika').value);
        d.kortit.push({id: document.getElementById('id-input').value, laji: document.getElementById('laji-input').value, t: t});
        d.tavoite += t;
        
        // Nollaus
        ["id-input", "laji-input", "a-aika", "t-aika", "m-nimi", "m-aika"].forEach(id => document.getElementById(id).value = "");
        document.getElementById('id-input').disabled = false;
        document.getElementById('laji-input').style.display = "none";
        document.getElementById('vaiheet').style.display = "none";
        document.getElementById('skannaus').style.display = "block";
        soita();
        tallennaLuonnos();
    }

    function paivita() {
        if(!d.aloitus) return;
        let s = Math.floor((Date.now() - d.aloitus)/1000);
        document.getElementById('kello').innerText = new Date(s*1000).toISOString().substr(11,8);
        if(d.kortit.length > 0) {
            document.getElementById('v-jout').innerText = ((d.tavoite/60)/(s/3600)).toFixed(2);
            document.getElementById('j-jout').innerText = (((jakso.min + d.tavoite)/60)/((jakso.sek + s)/3600)).toFixed(2);
        }
    }

    function tallennaLuonnos() { localStorage.setItem('sarmaysLuonnos', JSON.stringify(d)); }

    function tarkistaTila() {
        let l = JSON.parse(localStorage.getItem('sarmaysLuonnos'));
        if(l && l.aloitus) {
            d = l;
            document.getElementById('aloitus-paneeli').style.display = "none";
            document.getElementById('tyo-alue').style.display = "block";
            setInterval(paivita, 1000);
        }
    }

    function lopetaVuoro() {
        if(confirm("Lopetetaanko ja tallennetaanko vuoro?")) {
            jakso.min += d.tavoite;
            jakso.sek += Math.floor((Date.now() - d.aloitus)/1000);
            localStorage.setItem('sarmaysJakso', JSON.stringify(jakso));
            localStorage.removeItem('sarmaysLuonnos');
            location.reload();
        }
    }

    function nollaaKaikki() {
        if(confirm("Haluatko varmasti nollata koko jakson historian?")) {
            localStorage.clear();
            location.reload();
        }
    }

    function naytaRaportti() {
        document.getElementById('raportti-sisalto').innerHTML = d.kortit.map(k => `<p>${k.id} | ${k.laji} | ${k.t.toFixed(2)} min</p>`).join('');
        document.getElementById('raportti-alue').style.display = "block";
    }
    function suljeRaportti() { document.getElementById('raportti-alue').style.display = "none"; }
</script>
</body>
</html>
