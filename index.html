<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SärmäysPro - VAMM Steel</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { 
            --vamm-yellow: #fecb00; 
            --vamm-grey: #333d47;
            --bg: #1a1a1a;
            --card: #2d2d2d;
            --input-bg: #000000;
            --text: #ffffff;
        }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        
        .version-row { color: #ff5555; font-weight: 900; font-size: 0.8rem; text-align: center; margin-bottom: 5px; }
        
        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid var(--vamm-yellow); padding-bottom: 10px; }
        .logo-v { font-weight: 900; font-size: 2rem; color: var(--vamm-yellow); }
        .logo-s { font-weight: 300; font-size: 2rem; color: #fff; }

        .main-display { background: var(--card); padding: 25px; border-radius: 20px; text-align: center; border: 1px solid #444; margin-bottom: 20px; }
        .clock { font-size: 4.5rem; font-family: monospace; color: var(--vamm-yellow); font-weight: 900; margin: 10px 0; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .stat-item { background: rgba(0,0,0,0.4); padding: 12px 5px; border-radius: 12px; border: 1px solid #555; }
        .stat-val { font-size: 1.4rem; font-weight: 900; display: block; }
        .stat-lab { font-size: 0.65rem; color: #bbb; text-transform: uppercase; margin-top: 4px; }

        .btn-action { border: none; border-radius: 15px; font-weight: 900; font-size: 1.3rem; height: 80px; width: 100%; cursor: pointer; text-transform: uppercase; margin-top: 15px; }
        .btn-start { background: var(--vamm-yellow); color: #000; }
        .btn-stop { background: #d32f2f; color: #fff; }
        .btn-save { background: #388e3c; color: #fff; height: 65px; margin-top: 15px; font-size: 1.1rem; }

        .input-card { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid #444; margin-top: 20px; }
        input { width: 100%; padding: 15px; background: var(--input-bg); border: 1px solid #666; border-radius: 12px; color: #fff; font-size: 1.2rem; margin-bottom: 10px; text-align: center; }
        input:focus { border-color: var(--vamm-yellow); outline: none; }

        .history-row { display: flex; justify-content: space-between; padding: 15px; background: #222; margin-top: 8px; border-radius: 12px; border-left: 5px solid var(--vamm-yellow); }
        
        #scanner-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10000; display: none; flex-direction: column; }
    </style>
</head>
<body>

<div class="version-row">VERSION v6.1.0</div>

<div class="header">
    <span class="logo-v">VAMM</span><span class="logo-s">STEEL</span>
</div>

<div class="main-display">
    <div id="kello" class="clock">00:00:00</div>
    <div class="stat-grid">
        <div class="stat-item"><span id="eff_n" class="stat-val">0.00</span><span class="stat-lab">EFF</span></div>
        <div class="stat-item"><span id="min_n" class="stat-val">0</span><span class="stat-lab">MIN</span></div>
        <div class="stat-item" onclick="showHistory()" style="border-color: var(--vamm-yellow); cursor:pointer">
            <span id="eff_j" class="stat-val" style="color:var(--vamm-yellow)">0.00</span><span class="stat-lab">JAKSO</span>
        </div>
    </div>
</div>

<button id="shiftBtn" class="btn-action btn-start" onclick="toggleShift()">ALOITA VUORO</button>

<div id="workView" style="display:none">
    <div class="input-card">
        <input type="text" id="in_id" placeholder="TYÖNUMERO" onclick="openScanner('in_id')" readonly>
        <input type="text" id="in_laji" placeholder="LAJIMERKKI" onclick="openScanner('in_laji')" readonly>
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
            <input type="number" id="in_s" placeholder="ASET">
            <input type="number" id="in_t" placeholder="TAIV">
            <input type="number" id="in_m" placeholder="MUUT">
        </div>
        <button class="btn-action btn-save" onclick="saveJob()">TALLENNA TYÖ</button>
    </div>
    <div id="jobList" style="margin-top:15px;"></div>
</div>

<div id="scanner-modal">
    <div id="reader" style="flex:1"></div>
    <button class="btn-action btn-stop" style="border-radius:0; margin:0;" onclick="closeScanner()">SULJE</button>
</div>

<div id="archive-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#1a1a1a; z-index:9000; display:none; padding:20px; overflow-y:auto;">
    <button onclick="closeHistory()" style="float:right; background:none; border:none; color:#fff; font-size:3rem">✕</button>
    <h2 style="color:var(--vamm-yellow)">HISTORIA</h2>
    <div id="archiveContent"></div>
    <button onclick="resetApp()" class="btn-action btn-stop" style="margin-top:30px">NOLLAA JAKSO HISTORIA</button>
</div>

<script>
    // Käytetään täysin uutta muistiavainta v61
    let data = JSON.parse(localStorage.getItem('vamm_v61')) || { active: false, start: 0, jobs: [] };
    let archive = JSON.parse(localStorage.getItem('vamm_v61_arch')) || [];
    let qr = null;

    function persist() {
        localStorage.setItem('vamm_v61', JSON.stringify(data));
        localStorage.setItem('vamm_v61_arch', JSON.stringify(archive));
    }

    function toggleShift() {
        if (!data.active) {
            let t = prompt("Aloitusaika (HH:MM):", new Date().toLocaleTimeString('fi-FI',{hour:'2-digit',minute:'2-digit'}));
            if(!t) return;
            let [h, m] = t.split(':');
            let d = new Date(); d.setHours(h, m, 0, 0);
            data.start = d.getTime();
            data.active = true;
            data.jobs = [];
            // Äänimerkki
            try { let ctx=new AudioContext(); let o=ctx.createOscillator(); o.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.1); } catch(e){}
        } else {
            if(confirm("Lopetetaanko vuoro?")) {
                data.jobs.forEach(j => archive.push(j));
                data.active = false;
                data.start = 0;
            }
        }
        persist();
        ui();
    }

    function saveJob() {
        const id = document.getElementById('in_id').value;
        const laji = document.getElementById('in_laji').value;
        const s = document.getElementById('in_s').value;
        const t = document.getElementById('in_t').value;
        const m = document.getElementById('in_m').value || 0;

        if (id && laji && s !== "" && t !== "") {
            data.jobs.push({ id, laji, s: Number(s), t: Number(t), m: Number(m) });
            ['in_id','in_laji','in_s','in_t','in_m'].forEach(el => document.getElementById(el).value = "");
            persist();
            renderList();
        } else {
            alert("Täytä tiedot!");
        }
    }

    function openScanner(tid) {
        document.getElementById('scanner-modal').style.display = 'flex';
        qr = new Html5Qrcode("reader");
        qr.start({ facingMode: "environment" }, { fps: 20, qrbox: {width: 280, height: 140} }, (txt) => {
            document.getElementById(tid).value = txt;
            closeScanner();
        }).catch(()=>{});
    }

    function closeScanner() {
        if(qr) qr.stop().then(() => { document.getElementById('scanner-modal').style.display='none'; qr=null; });
    }

    function run() {
        if (data.active && data.start > 0) {
            let diff = Date.now() - data.start;
            if (diff < 0) diff = 0;
            let h = Math.floor(diff/3600000);
            let m = Math.floor((diff%3600000)/60000);
            let s = Math.floor((diff%60000)/1000);
            document.getElementById('kello').innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            
            let curM = data.jobs.reduce((a, b) => a + (b.s+b.t+b.m), 0);
            document.getElementById('eff_n').innerText = (diff/60000) > 0.5 ? (curM / (diff/60000)).toFixed(2) : "0.00";
            document.getElementById('min_n').innerText = Math.round(curM);
            let totM = archive.reduce((a, b) => a + (b.s+b.t+b.m), 0) + curM;
            document.getElementById('eff_j').innerText = (totM / 480).toFixed(2);
        } else {
            document.getElementById('kello').innerText = "00:00:00";
        }
        requestAnimationFrame(run);
    }

    function renderList() {
        let h = document.getElementById('jobList');
        h.innerHTML = "";
        [...data.jobs].reverse().forEach(j => {
            h.innerHTML += `<div class="history-row"><b>#${j.id}</b> <span>${j.laji}</span> <b>${j.s+j.t+j.m} min</b></div>`;
        });
    }

    function ui() {
        document.getElementById('shiftBtn').innerText = data.active ? "LOPETA VUORO" : "ALOITA VUORO";
        document.getElementById('shiftBtn').className = "btn-action " + (data.active ? "btn-stop" : "btn-start");
        document.getElementById('workView').style.display = data.active ? "block" : "none";
        renderList();
    }

    function resetApp() {
        if(confirm("Haluatko varmasti nollata koko jakson historian")) {
            localStorage.clear();
            location.reload();
        }
    }

    function showHistory() { document.getElementById('archive-modal').style.display='block'; }
    function closeHistory() { document.getElementById('archive-modal').style.display='none'; }

    window.onload = () => { ui(); run(); };
</script>
</body>
</html>
