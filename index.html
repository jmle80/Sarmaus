<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SärmäysPro - VAMM Steel</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { 
            --vamm-yellow: #fecb00; 
            --vamm-steel: #333d47;
            --bg: #000;
            --card: #161616;
            --text: #fff;
        }
        * { box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; overflow-x: hidden; }
        
        .version-tag { color: var(--vamm-yellow); font-weight: 900; font-size: 0.7rem; text-align: center; margin-bottom: 5px; letter-spacing: 1px; }
        
        /* VAMM LOGO */
        .vamm-header { text-align: center; margin: 10px 0 20px 0; border-bottom: 2px solid var(--vamm-yellow); padding-bottom: 10px; }
        .vamm-logo-text { font-size: 2.2rem; font-weight: 900; letter-spacing: -1px; }
        .vamm-logo-sub { font-weight: 300; }

        .card { background: var(--card); padding: 20px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #222; }
        
        .timer-display { font-size: 5rem; font-family: 'Courier New', monospace; text-align: center; color: var(--vamm-yellow); font-weight: 900; margin: 10px 0; line-height: 1; }
        
        .grid-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 15px; }
        .stat-item { background: #000; padding: 10px 5px; border-radius: 8px; text-align: center; border: 1px solid #333; }
        .stat-val { font-size: 1.3rem; font-weight: 900; display: block; }
        .stat-lbl { font-size: 0.6rem; color: #888; text-transform: uppercase; margin-top: 2px; display: block; }

        .btn { border: none; border-radius: 10px; font-weight: 900; font-size: 1.2rem; cursor: pointer; height: 75px; width: 100%; text-transform: uppercase; transition: 0.1s; display: flex; align-items: center; justify-content: center; }
        .btn:active { transform: scale(0.95); opacity: 0.8; }
        .btn-start { background: var(--vamm-yellow); color: #000; }
        .btn-stop { background: #d32f2f; color: #fff; }
        .btn-gray { background: var(--vamm-steel); color: #fff; }

        input { width: 100%; padding: 16px; background: #000; border: 1px solid #444; border-radius: 8px; color: #fff; font-size: 1.2rem; text-align: center; margin-bottom: 8px; font-weight: bold; }
        input:focus { border-color: var(--vamm-yellow); outline: none; }
        input:disabled { opacity: 0.2; }

        .log-row { display: flex; padding: 15px; background: #111; margin-bottom: 4px; border-radius: 6px; align-items: center; border-left: 4px solid var(--vamm-yellow); }
        .log-id { flex: 1; font-weight: bold; color: var(--vamm-yellow); }
        .log-laji { flex: 2; font-size: 0.9rem; }
        .log-time { flex: 1; text-align: right; font-weight: 900; color: #ff9800; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; display: none; flex-direction: column; padding: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="version-tag">VERSION v5.2.7</div>
    
    <div class="vamm-header">
        <span class="vamm-logo-text"><span style="color:var(--vamm-yellow)">VAMM</span> <span class="vamm-logo-sub">STEEL</span></span>
    </div>

    <div class="card">
        <div id="display" class="timer-display">00:00:00</div>
        <div class="grid-stats">
            <div class="stat-item"><span id="eff" class="stat-val">0.00</span><span class="stat-lbl">EFF</span></div>
            <div class="stat-item"><span id="mins" class="stat-val">0</span><span class="stat-lbl">MIN</span></div>
            <div class="stat-item" onclick="viewArchive()" style="border-color:var(--vamm-yellow)"><span id="pEff" class="stat-val" style="color:var(--vamm-yellow)">0.00</span><span class="stat-lbl">JAKSO</span></div>
        </div>
    </div>

    <div style="margin-bottom: 15px;">
        <button id="mainBtn" class="btn btn-start" onclick="handleMainAction()">ALOITA VUORO</button>
    </div>

    <div id="controls" style="display:none">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
            <button class="btn btn-gray" style="height:55px; font-size:0.9rem; background:#b71c1c" onclick="addManual('HÄIRIÖ')">HÄIRIÖ</button>
            <button class="btn btn-gray" style="height:55px; font-size:0.9rem; background:#4a148c" onclick="addManual('PROTO')">PROTO</button>
        </div>
        <input type="text" id="in_id" placeholder="TYÖNUMERO" readonly onclick="startScan('in_id')">
        <input type="text" id="in_laji" placeholder="LAJIMERKKI" readonly onclick="startScan('in_laji')">
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px;">
            <input type="number" id="in_s" placeholder="ASET" oninput="checkData()">
            <input type="number" id="in_t" placeholder="TAIV" oninput="checkData()">
            <input type="number" id="in_m" placeholder="MUUT" oninput="checkData()">
        </div>
    </div>

    <div id="log" style="margin-top:10px;"></div>
</div>

<div id="archModal" class="modal">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="color:var(--vamm-yellow)">ARKISTO</h2>
        <button onclick="closeArchive()" style="background:none; border:none; color:#fff; font-size:3rem;">✕</button>
    </div>
    <div id="archContent" style="flex:1; overflow-y:auto;"></div>
    <button onclick="clearHistory()" class="btn btn-stop" style="margin-top:20px;">NOLLAA JAKSO HISTORIA</button>
</div>

<div id="scanner" class="modal" style="justify-content:center; align-items:center;">
    <div id="reader" style="width:100%;"></div>
    <button onclick="stopScan()" class="btn btn-gray" style="margin-top:20px; width:80%;">SULJE</button>
</div>

<script>
    // DATA
    let db = JSON.parse(localStorage.getItem('vamm_v7_db')) || { active: false, start: 0, log: [] };
    let arch = JSON.parse(localStorage.getItem('vamm_v7_arch')) || [];
    let qrcode = null;

    function save() {
        localStorage.setItem('vamm_v7_db', JSON.stringify(db));
        localStorage.setItem('vamm_v7_arch', JSON.stringify(arch));
    }

    function sound() { try { const ctx = new AudioContext(); const osc = ctx.createOscillator(); osc.connect(ctx.destination); osc.start(); osc.stop(ctx.currentTime+0.15); } catch(e){} }

    function handleMainAction() {
        if (!db.active) {
            let t = prompt("Aloitusaika (HH:MM):", new Date().toLocaleTimeString('fi-FI',{hour:'2-digit',minute:'2-digit'}));
            if(!t) return;
            const [h, m] = t.split(':');
            const d = new Date(); d.setHours(h, m, 0, 0);
            db.start = d.getTime();
            db.active = true;
            db.log = [];
            sound();
        } else {
            if(confirm("Lopetetaanko vuoro?")) {
                db.log.forEach(item => arch.push(item));
                db.active = false;
                db.start = 0;
            }
        }
        save();
        updateUI();
    }

    function tick() {
        if (db.active && db.start > 0) {
            const now = Date.now();
            const diff = now - db.start;
            const s = Math.floor(diff / 1000);
            const hh = Math.floor(s / 3600);
            const mm = Math.floor((s % 3600) / 60);
            const ss = s % 60;
            document.getElementById('display').innerText = 
                `${hh.toString().padStart(2,'0')}:${mm.toString().padStart(2,'0')}:${ss.toString().padStart(2,'0')}`;
            
            const totalMins = db.log.reduce((a, b) => a + (Number(b.s)+Number(b.t)+Number(b.m)), 0);
            const diffMins = diff / 60000;
            document.getElementById('eff').innerText = diffMins > 0.5 ? (totalMins / diffMins).toFixed(2) : "0.00";
            document.getElementById('mins').innerText = Math.round(totalMins);
            
            // Jakso EFF (Kaikki arkistoidut + nykyinen)
            const allMins = arch.reduce((a, b) => a + (Number(b.s)+Number(b.t)+Number(b.m)), 0) + totalMins;
            document.getElementById('pEff').innerText = (allMins / 480).toFixed(2); // Laskentakaava per 8h
        } else {
            document.getElementById('display').innerText = "00:00:00";
        }
        requestAnimationFrame(tick);
    }

    function checkData() {
        const id = document.getElementById('in_id').value;
        const laji = document.getElementById('in_laji').value;
        const s = document.getElementById('in_s').value;
        const t = document.getElementById('in_t').value;
        const m = document.getElementById('in_m').value || 0;

        if (id.length > 3 && laji && s !== "" && t !== "") {
            db.log.push({ id, laji, s:Number(s), t:Number(t), m:Number(m) });
            ['in_id','in_laji','in_s','in_t','in_m'].forEach(k => document.getElementById(k).value = "");
            save();
            renderLog();
        }
    }

    function renderLog() {
        const div = document.getElementById('log');
        div.innerHTML = "";
        [...db.log].reverse().forEach((i, idx) => {
            div.innerHTML += `<div class="log-row" onclick="editRow(${db.log.length-1-idx})">
                <span class="log-id">#${i.id}</span>
                <span class="log-laji">${i.laji}</span>
                <span class="log-time">${(i.s+i.t+i.m)}m</span>
            </div>`;
        });
    }

    function editRow(idx) {
        const val = prompt("Muokkaa aikaa (min):", (db.log[idx].s + db.log[idx].t + db.log[idx].m));
        if (val) { db.log[idx].s = Number(val); db.log[idx].t = 0; db.log[idx].m = 0; save(); renderLog(); }
    }

    function updateUI() {
        const btn = document.getElementById('mainBtn');
        const ctr = document.getElementById('controls');
        if (db.active) {
            btn.innerText = "LOPETA VUORO";
            btn.className = "btn btn-stop";
            ctr.style.display = "block";
        } else {
            btn.innerText = "ALOITA VUORO";
            btn.className = "btn btn-start";
            ctr.style.display = "none";
        }
        renderLog();
    }

    function clearHistory() {
        if(confirm("Haluatko varmasti nollata koko jakson historian")) {
            localStorage.clear();
            location.reload();
        }
    }

    function startScan(target) {
        document.getElementById('scanner').style.display = 'flex';
        if(!qrcode) qrcode = new Html5Qrcode("reader");
        qrcode.start({ facingMode: "environment" }, { fps: 20, qrbox: 250 }, (text) => {
            document.getElementById(target).value = text;
            stopScan();
        }).catch(() => {});
    }

    function stopScan() { 
        if(qrcode) qrcode.stop().then(() => { document.getElementById('scanner').style.display = 'none'; });
    }

    function viewArchive() { document.getElementById('archModal').style.display = 'flex'; }
    function closeArchive() { document.getElementById('archModal').style.display = 'none'; }
    function addManual(type) { const s = prompt(type + " syy:"); if(s) { db.log.push({id:"---", laji:type+": "+s, s:0, t:0, m:0}); save(); renderLog(); } }

    // KÄYNNISTYS
    updateUI();
    requestAnimationFrame(tick);
</script>
</body>
</html>
