<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SärmäysPro v4.2.0</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { 
            --bg: #0f1115; --card: #1a1d23; --text: #e2e8f0; 
            --primary: #f58220; --accent: #22c55e; 
            --danger: #ef4444; --warn: #fbbf24; --proto: #a855f7; 
            --gray: #2d333f; --light-gray: #94a3b8;
            --version-color: #ffff00;
        }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; min-height: 100vh; }
        .container { max-width: 420px; margin: auto; }
        
        .version-header { color: var(--version-color); font-weight: 800; font-size: 0.75rem; text-align: right; margin-bottom: 4px; opacity: 0.8; }
        
        .header-box { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--card); border-radius: 12px; margin-bottom: 10px; border-bottom: 2px solid var(--accent); }
        .logo-text { font-weight: 900; font-size: 1.2rem; }

        .card { background: var(--card); padding: 12px; border-radius: 12px; border: 1px solid var(--gray); margin-bottom: 10px; }
        .timer-val { font-size: 2.8rem; font-family: 'Courier New', monospace; text-align: center; color: var(--primary); font-weight: 900; line-height: 1; margin: 5px 0 12px 0; }
        
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .stat-item { background: rgba(0,0,0,0.2); padding: 8px 4px; border-radius: 8px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .stat-label { font-size: 0.6rem; color: var(--light-gray); text-transform: uppercase; display: block; margin-bottom: 2px; }
        .stat-value { font-size: 1rem; font-weight: 800; }

        .eff-good { color: var(--accent); }
        .eff-bad { color: var(--danger); }

        .input-group { display: flex; flex-direction: column; gap: 8px; }
        input { padding: 14px; background: #000; border: 2px solid var(--gray); border-radius: 10px; color: #fff; font-size: 16px; font-weight: 700; text-align: center; width: 100%; }
        input:focus { border-color: var(--primary); outline: none; background: #050505; }
        
        .controls-grid { display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .btn { border: none; border-radius: 10px; padding: 14px 5px; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 0.7rem; color: white; transition: opacity 0.2s; }
        .btn:active { opacity: 0.7; }
        .btn:disabled { background: var(--gray) !important; color: #555; pointer-events: none; }

        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--gray); font-size: 0.8rem; }
        .history-item:last-child { border-bottom: none; }

        #reader-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #reader { width: 85%; border-radius: 15px; overflow: hidden; border: 3px solid var(--accent); }
    </style>
</head>
<body>

<div id="reader-container">
    <div id="reader"></div>
    <button id="cancel-scan" class="btn" style="background:var(--danger); width:200px; margin-top:20px;">PERUUTA</button>
</div>

<div class="container">
    <div class="version-header">V4.2.0</div>
    
    <div class="header-box">
        <span class="logo-text"><span style="color:var(--primary)">VAMM</span> Steel</span>
        <button id="shiftBtn" class="btn" style="background:var(--accent); min-width:80px; padding:8px;" onclick="toggleShift()">ALKU</button>
    </div>
    
    <div class="card">
        <div id="mainClock" class="timer-val">00:00:00</div>
        <div class="stats-row">
            <div class="stat-item"><span class="stat-label">VUORO EFF</span><span id="shiftEff" class="stat-value">-</span></div>
            <div class="stat-item"><span class="stat-label">MIN</span><span id="shiftMins" class="stat-value">0</span></div>
            <div class="stat-item"><span class="stat-label">KORTIT</span><span id="shiftCount" class="stat-value">0</span></div>
        </div>
        <div class="stats-row" style="margin-top:8px; border-top:1px solid var(--gray); padding-top:8px;">
            <div class="stat-item"><span class="stat-label">JAKSO EFF</span><span id="periodEff" class="stat-value">-</span></div>
            <div class="stat-item"><span class="stat-label">J. MIN</span><span id="periodMins" class="stat-value">0</span></div>
            <div class="stat-item"><span class="stat-label">J. KORTIT</span><span id="periodCount" class="stat-value">0</span></div>
        </div>
    </div>

    <div class="controls-grid">
        <button class="btn" style="background: var(--warn); color:#000;" onclick="handleManualEntry('FAIL')" id="failBtn" disabled>HÄIRIÖ</button>
        <button class="btn" style="background: var(--proto);" onclick="handleManualEntry('PROTO')" id="protoBtn" disabled>PROTO</button>
        <button class="btn" style="background: var(--primary); color:#000;" id="saveBtn" onclick="addJob()" disabled>TALLENNA</button>
    </div>

    <div class="card input-group">
        <input type="text" id="in_id" placeholder="KORTIN NUMERO" inputmode="numeric" onfocus="handleInputFocus('in_id')" oninput="validateID(this)" disabled>
        <input type="text" id="in_laji" placeholder="LAJIMERKKI" onfocus="handleInputFocus('in_laji')" disabled>
        <div class="stats-row">
            <input type="number" id="in_s" placeholder="ASET" inputmode="decimal" disabled>
            <input type="number" id="in_t" placeholder="TAIV" inputmode="decimal" disabled>
            <input type="number" id="in_m" placeholder="MUUT" inputmode="decimal" disabled>
        </div>
    </div>

    <div id="historyList" class="card" style="padding:0; max-height:150px; overflow-y:auto;"></div>
    
    <button class="btn" style="background: transparent; color: var(--danger); border:1px solid var(--danger); width:100%; margin-top:5px; padding:8px;" onclick="resetPeriod()">NOLLAA JAKSO</button>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('sarmays_current_shift')) || { isRunning: false, startTime: null, shiftLog: [] };
    let periodDb = JSON.parse(localStorage.getItem('sarmays_period_data')) || { totalMins: 0, totalCards: 0, totalWorkTimeMs: 0 };
    let html5QrCode = null;
    let manualMode = false;

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function beep(freq, dur) {
        try {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.frequency.value = freq; gain.gain.value = 0.05;
            osc.start(); osc.stop(audioCtx.currentTime + dur);
        } catch(e) {}
    }

    function calculateStats() {
        let sMins = 0, sCards = 0;
        db.shiftLog.forEach(i => { if(i.type==='JOB') { sMins += (i.s + i.t + i.m); sCards++; } });
        
        let sTimeMin = db.isRunning ? (Date.now() - db.startTime) / 60000 : 0;
        let sEff = sTimeMin > 0.5 ? (sMins / sTimeMin) : 0;
        
        const sEffEl = document.getElementById('shiftEff');
        sEffEl.innerText = sEff > 0 ? sEff.toFixed(2) : "-";
        sEffEl.className = 'stat-value ' + (sEff >= 1.0 ? 'eff-good' : (sEff > 0 ? 'eff-bad' : ''));
        
        document.getElementById('shiftMins').innerText = Math.round(sMins);
        document.getElementById('shiftCount').innerText = sCards;

        let pTimeMin = (periodDb.totalWorkTimeMs + (db.isRunning ? (Date.now() - db.startTime) : 0)) / 60000;
        let pMinsDone = periodDb.totalMins + sMins;
        let pEff = pTimeMin > 0.5 ? (pMinsDone / pTimeMin) : 0;

        const pEffEl = document.getElementById('periodEff');
        pEffEl.innerText = pEff > 0 ? pEff.toFixed(2) : "-";
        pEffEl.className = 'stat-value ' + (pEff >= 1.0 ? 'eff-good' : (pEff > 0 ? 'eff-bad' : ''));
        
        document.getElementById('periodMins').innerText = Math.round(pMinsDone);
        document.getElementById('periodCount').innerText = periodDb.totalCards + sCards;
    }

    function toggleShift() {
        if(!db.isRunning) {
            let t = prompt("Aloitusaika (HH:MM):", new Date().toLocaleTimeString('fi-FI', {hour:'2-digit', minute:'2-digit'}));
            if(!t) return;
            db.startTime = Date.now(); db.isRunning = true; db.shiftLog = [];
            beep(800, 0.1);
        } else {
            periodDb.totalMins += db.shiftLog.reduce((a, b) => a + (b.type==='JOB' ? (b.s+b.t+b.m) : 0), 0);
            periodDb.totalCards += db.shiftLog.filter(i => i.type==='JOB').length;
            periodDb.totalWorkTimeMs += (Date.now() - db.startTime);
            localStorage.setItem('sarmays_period_data', JSON.stringify(periodDb));
            db.isRunning = false;
        }
        localStorage.setItem('sarmays_current_shift', JSON.stringify(db));
        updateUI(); calculateStats(); renderHistory();
    }

    function validateID(el) {
        el.value = el.value.replace(/\D/g, '').substring(0, 6);
        if (el.value.length === 6) { beep(400, 0.05); document.getElementById('in_laji').focus(); }
        document.getElementById('saveBtn').disabled = el.value.length !== 6;
    }

    function addJob() {
        db.shiftLog.push({ 
            id: document.getElementById('in_id').value, 
            laji: document.getElementById('in_laji').value,
            type: 'JOB', s: parseFloat(document.getElementById('in_s').value)||0, 
            t: parseFloat(document.getElementById('in_t').value)||0, 
            m: parseFloat(document.getElementById('in_m').value)||0,
            timestamp: Date.now()
        });
        ['in_id','in_laji','in_s','in_t','in_m'].forEach(i => document.getElementById(i).value="");
        localStorage.setItem('sarmays_current_shift', JSON.stringify(db));
        beep(440, 0.1); calculateStats(); renderHistory(); document.getElementById('saveBtn').disabled = true;
    }

    function handleManualEntry(type) {
        if (type === 'PROTO') {
            startScanner((text) => completeEntry(type, text));
            document.getElementById('cancel-scan').onclick = () => { stopScanner(); let r = prompt("Lajimerkki:"); if(r) completeEntry(type, r); };
        } else {
            let reason = prompt("Häiriön syy?"); if(reason) completeEntry(type, reason);
        }
    }

    function completeEntry(type, id) {
        let t = new Date().toLocaleTimeString('fi-FI', {hour:'2-digit', minute:'2-digit'});
        let s = prompt("Alku?", t); let e = prompt("Loppu?", t);
        if(id && s && e) {
            db.shiftLog.push({ id: id, type: type, timestamp: Date.now(), manualTime: s + "-" + e });
            localStorage.setItem('sarmays_current_shift', JSON.stringify(db));
            renderHistory(); calculateStats();
        }
    }

    function resetPeriod() {
        if(confirm("Haluatko varmasti nollata koko jakson historian?")) {
            periodDb = { totalMins: 0, totalCards: 0, totalWorkTimeMs: 0 };
            localStorage.setItem('sarmays_period_data', JSON.stringify(periodDb));
            db = { isRunning: false, startTime: null, shiftLog: [] };
            localStorage.setItem('sarmays_current_shift', JSON.stringify(db));
            location.reload();
        }
    }

    function handleInputFocus(id) {
        if (!manualMode && db.isRunning) {
            startScanner((text) => {
                document.getElementById(id).value = id === 'in_id' ? text.replace(/\D/g, '').substring(0, 6) : text;
                if (id === 'in_id') validateID(document.getElementById(id));
            });
        }
        manualMode = false;
    }

    async function startScanner(callback) {
        const container = document.getElementById('reader-container');
        container.style.display = 'flex';
        if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
        try {
            await html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (text) => { callback(text); stopScanner(); });
        } catch (err) { stopScanner(); }
    }

    function stopScanner() {
        if (html5QrCode) html5QrCode.stop().catch(() => {});
        document.getElementById('reader-container').style.display = 'none';
    }

    function updateUI() {
        document.getElementById('shiftBtn').innerText = db.isRunning ? "LOPPU" : "ALKU";
        document.getElementById('shiftBtn').style.background = db.isRunning ? "var(--danger)" : "var(--accent)";
        ['in_id','in_laji','in_s','in_t','in_m','failBtn','protoBtn'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.disabled = !db.isRunning;
        });
    }

    function renderHistory() {
        const c = document.getElementById('historyList'); c.innerHTML = "";
        db.shiftLog.slice().reverse().forEach(item => {
            let div = document.createElement('div'); div.className = "history-item";
            let label = item.type === 'PROTO' ? `P: ${item.id}` : item.type === 'FAIL' ? `H: ${item.id}` : `#${item.id}`;
            div.innerHTML = `<span>${label}</span><span style="font-family:monospace">${item.manualTime || new Date(item.timestamp).toLocaleTimeString('fi-FI', {hour:'2-digit', minute:'2-digit'})}</span>`;
            c.appendChild(div);
        });
    }

    setInterval(() => {
        if(db.isRunning) document.getElementById('mainClock').innerText = new Date(Date.now() - db.startTime).toISOString().substr(11, 8);
        calculateStats();
    }, 1000);

    updateUI(); calculateStats(); renderHistory();
</script>
</body>
</html>
