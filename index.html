<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S√§rm√§ys Pro v3.9.2</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        .version-tag { color: #ff8c00; font-weight: bold; padding: 10px; font-size: 0.8rem; }
        body { font-family: sans-serif; text-align: center; padding: 10px; background: #f0f2f5; }
        #tyoaika-display { font-family: monospace; font-size: 2rem; margin: 10px 0; }
        
        #reader { width: 300px !important; height: 180px !important; margin: 10px auto; border-radius: 12px; overflow: hidden; background: #000; border: 3px solid #ccc; }
        .vaihe-id { border-color: #007bff !important; }
        .vaihe-laji { border-color: #ffc107 !important; }

        .ohje-teksti { font-weight: bold; font-size: 1.2rem; margin: 10px; color: #333; }
        .ilmoitus { padding: 10px; border-radius: 8px; margin: 10px; font-weight: bold; }
        .virhe { background: #dc3545; color: white; }
        
        /* Kenttien tyylit */
        .kentta-ryhma { margin: 10px 0; }
        input { width: 85%; padding: 12px; margin: 5px; font-size: 1.2rem; text-align: center; border-radius: 8px; border: 2px solid #ddd; }
        input:focus { border-color: #007bff; outline: none; }
        
        #laji-osio { display: none; } /* Piilossa aluksi */

        button { width: 100%; padding: 20px; font-size: 1.2rem; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-aloita { background: #28a745; color: white; }
        .btn-lopeta { background: #dc3545; color: white; }
    </style>
</head>
<body>
    <div class="version-tag">Versio 3.9.2 üü†</div>
    <div id="tyoaika-display">00:00:00</div>

    <div id="tyo-alue" style="display:none;">
        <div id="ohje" class="ohje-teksti">Sy√∂t√§ tai skannaa ID (6 numeroa) üî¢</div>
        <div id="reader" class="vaihe-id"></div>
        
        <div id="id-osio" class="kentta-ryhma">
            <input type="tel" id="id-syotto" placeholder="Sy√∂t√§ 6 numeroa" maxlength="6" oninput="tarkistaId(this.value)">
        </div>

        <div id="laji-osio" class="kentta-ryhma">
            <div class="ohje-teksti" style="color: #856404;">Skannaa nyt lajimerkki üè∑Ô∏è</div>
            <input type="text" id="laji-naytto" readonly placeholder="Odotetaan lajikoodia...">
        </div>
        
        <div id="info-ruutu"></div>
        
        <button class="btn-lopeta" onclick="lopetaVuoro()">LOPETA VUORO üèÅ</button>
    </div>

    <button id="aloita-nappi" class="btn-aloita" onclick="aloitaVuoro()">ALOITA TY√ñVUORO üöÄ</button>

<script>
    let aloitusAikaleima = null;
    let kelloInterval = null;
    let html5QrCode = null;
    let tehdytKortit = [];
    let nykyinenVaihe = "ID";
    let tallennettuID = "";

    function aloitaVuoro() {
        let syote = prompt("Aloitusaika (HH:MM) tai tyhj√§:", "");
        if (syote === null) return;
        let nyt = new Date();
        if (syote.trim() !== "") {
            let osat = syote.split(/[:.]/);
            if (osat.length >= 2) nyt.setHours(parseInt(osat[0]), parseInt(osat[1]), 0, 0);
        }
        aloitusAikaleima = nyt.getTime();
        document.getElementById('aloita-nappi').style.display = "none";
        document.getElementById('tyo-alue').style.display = "block";
        kelloInterval = setInterval(paivitaKello, 1000);
        kaynnistaSkanneri();
    }

    function kaynnistaSkanneri() {
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 200 }, (txt) => {
            if (nykyinenVaihe === "ID") {
                tarkistaId(txt);
            } else {
                tallennaLaji(txt);
            }
        });
    }

    // Tarkistaa sek√§ k√§sin sy√∂tetyn ett√§ skannatun ID:n
    function tarkistaId(arvo) {
        const puhdas = arvo.trim();
        if (/^\d{6}$/.test(puhdas)) {
            tallennettuID = puhdas;
            document.getElementById('id-syotto').value = puhdas;
            document.getElementById('id-syotto').disabled = true; // Lukitaan ID
            
            // Vaihdetaan tila
            nykyinenVaihe = "LAJI";
            document.getElementById('ohje').innerText = "ID Hyv√§ksytty!";
            document.getElementById('laji-osio').style.display = "block";
            document.getElementById('reader').className = "vaihe-laji";
            
            new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play().catch(()=>{});
        }
    }

    function tallennaLaji(txt) {
        const laji = txt.trim();
        document.getElementById('laji-naytto').value = laji;
        
        tehdytKortit.push({
            id: tallennettuID,
            laji: laji,
            aika: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
        });

        // Palautus alkutilaan uutta korttia varten
        setTimeout(() => {
            nykyinenVaihe = "ID";
            tallennettuID = "";
            document.getElementById('id-syotto').value = "";
            document.getElementById('id-syotto').disabled = false;
            document.getElementById('laji-naytto').value = "";
            document.getElementById('laji-osio').style.display = "none";
            document.getElementById('ohje').innerText = "Sy√∂t√§ tai skannaa ID (6 numeroa) üî¢";
            document.getElementById('reader').className = "vaihe-id";
        }, 1500);
    }

    function paivitaKello() {
        let erotusMs = new Date().getTime() - aloitusAikaleima;
        let sek = Math.floor(erotusMs / 1000);
        let h = Math.floor(sek / 3600).toString().padStart(2, '0');
        let m = Math.floor((sek % 3600) / 60).toString().padStart(2, '0');
        let s = (sek % 60).toString().padStart(2, '0');
        document.getElementById('tyoaika-display').innerText = `${h}:${m}:${s}`;
    }

    function lopetaVuoro() {
        if (confirm("Lopetetaanko vuoro? Kortteja: " + tehdytKortit.length)) {
            location.reload();
        }
    }
</script>
</body>
</html>
