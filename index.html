<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S√§rm√§ys Pro v3.9.1</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        .version-tag { color: #ff8c00; font-weight: bold; padding: 10px; font-size: 0.8rem; }
        body { font-family: sans-serif; text-align: center; padding: 10px; background: #f0f2f5; }
        #tyoaika-display { font-family: monospace; font-size: 2rem; margin: 10px 0; }
        
        #reader { width: 300px !important; height: 180px !important; margin: 10px auto; border-radius: 12px; overflow: hidden; background: #000; border: 3px solid #ccc; }
        /* Vaihtuva reunan v√§ri kertoo vaiheen */
        .vaihe-id { border-color: #007bff !important; }
        .vaihe-laji { border-color: #ffc107 !important; }

        .ohje-teksti { font-weight: bold; font-size: 1.2rem; margin: 10px; color: #333; }
        .ilmoitus { padding: 10px; border-radius: 8px; margin: 10px; font-weight: bold; }
        .virhe { background: #dc3545; color: white; }
        .onnistuminen { background: #28a745; color: white; }

        input { width: 80%; padding: 10px; margin: 5px; font-size: 1.1rem; text-align: center; border-radius: 8px; border: 1px solid #ccc; background: #eee; }
        button { width: 100%; padding: 20px; font-size: 1.2rem; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-aloita { background: #28a745; color: white; }
        .btn-lopeta { background: #dc3545; color: white; }
    </style>
</head>
<body>
    <div class="version-tag">Versio 3.9.1 üü†</div>
    <div id="tyoaika-display">00:00:00</div>

    <div id="tyo-alue" style="display:none;">
        <div id="ohje" class="ohje-teksti">Skannaa ID (6 numeroa) üî¢</div>
        <div id="reader" class="vaihe-id"></div>
        
        <div id="info-ruutu"></div>
        
        <input type="text" id="id-kentta" readonly placeholder="ID">
        <input type="text" id="laji-kentta" readonly placeholder="Lajimerkki">
        
        <button class="btn-lopeta" onclick="lopetaVuoro()">LOPETA VUORO üèÅ</button>
    </div>

    <button id="aloita-nappi" class="btn-aloita" onclick="aloitaVuoro()">ALOITA TY√ñVUORO üöÄ</button>

<script>
    let aloitusAikaleima = null;
    let kelloInterval = null;
    let html5QrCode = null;
    let tehdytKortit = [];
    
    let nykyinenVaihe = "ID"; // "ID" tai "LAJI"
    let puskuriID = "";

    function aloitaVuoro() {
        let syote = prompt("Aloitusaika (HH:MM) tai tyhj√§:", "");
        if (syote === null) return;
        let nyt = new Date();
        if (syote.trim() !== "") {
            let osat = syote.split(/[:.]/);
            if (osat.length >= 2) nyt.setHours(parseInt(osat[0]), parseInt(osat[1]), 0, 0);
        }
        aloitusAikaleima = nyt.getTime();
        document.getElementById('aloita-nappi').style.display = "none";
        document.getElementById('tyo-alue').style.display = "block";
        kelloInterval = setInterval(paivitaKello, 1000);
        kaynnistaSkanneri();
    }

    function kaynnistaSkanneri() {
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 200 }, (txt) => {
            kasitteleSkannaus(txt);
        });
    }

    function kasitteleSkannaus(txt) {
        const ohje = document.getElementById('ohje');
        const reader = document.getElementById('reader');
        const info = document.getElementById('info-ruutu');

        if (nykyinenVaihe === "ID") {
            if (/^\d{6}$/.test(txt)) {
                puskuriID = txt;
                document.getElementById('id-kentta').value = "ID: " + txt;
                
                // Siirryt√§√§n lajivaiheeseen
                nykyinenVaihe = "LAJI";
                ohje.innerText = "Skannaa Lajimerkki üè∑Ô∏è";
                reader.className = "vaihe-laji";
                info.innerHTML = `<div class="ilmoitus onnistuminen">ID Hyv√§ksytty! Skannaa nyt laji.</div>`;
                new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play().catch(()=>{});
            } else {
                info.innerHTML = `<div class="ilmoitus virhe">‚ùå V√§√§r√§ ID (pit√§√§ olla 6 numeroa)</div>`;
            }
        } 
        else if (nykyinenVaihe === "LAJI") {
            // Hyv√§ksyt√§√§n mik√§ tahansa teksti
            let laji = txt.trim();
            document.getElementById('laji-kentta').value = "Laji: " + laji;
            
            // Tallennetaan kortti
            tehdytKortit.push({
                id: puskuriID,
                laji: laji,
                aika: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            });

            // Palataan ID-vaiheeseen
            nykyinenVaihe = "ID";
            ohje.innerText = "Skannaa ID (6 numeroa) üî¢";
            reader.className = "vaihe-id";
            info.innerHTML = `<div class="ilmoitus onnistuminen">Kortti tallennettu! Seuraava ID...</div>`;
            
            // Tyhjennet√§√§n kent√§t pienen viiveen j√§lkeen
            setTimeout(() => {
                document.getElementById('id-kentta').value = "";
                document.getElementById('laji-kentta').value = "";
                info.innerHTML = "";
            }, 2000);
        }
    }

    function paivitaKello() {
        let erotusMs = new Date().getTime() - aloitusAikaleima;
        let sek = Math.floor(erotusMs / 1000);
        let h = Math.floor(sek / 3600).toString().padStart(2, '0');
        let m = Math.floor((sek % 3600) / 60).toString().padStart(2, '0');
        let s = (sek % 60).toString().padStart(2, '0');
        document.getElementById('tyoaika-display').innerText = `${h}:${m}:${s}`;
    }

    function lopetaVuoro() {
        if (confirm("Lopetetaanko vuoro? Tehtyj√§ kortteja: " + tehdytKortit.length)) {
            location.reload();
        }
    }
</script>
</body>
</html>
