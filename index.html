<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S√§rm√§ys Pro v3.3</title>
    <style>
        .version-tag { color: #ff8c00; font-weight: bold; padding: 10px; font-size: 0.8rem; }
        body { font-family: sans-serif; margin: 0; background: #f0f0f0; display: flex; justify-content: center; }
        #app-card { background: white; width: 100%; max-width: 500px; min-height: 100vh; padding: 20px; box-sizing: border-box; text-align: center; position: relative; }
        #tyoaika-kello { position: absolute; top: 10px; right: 10px; background: #333; color: #0f0; padding: 5px 10px; border-radius: 5px; font-family: monospace; font-size: 1.1rem; }
        button { width: 100%; padding: 18px; font-size: 1.1rem; border-radius: 12px; border: none; margin: 8px 0; font-weight: bold; cursor: pointer; }
        .btn-start { background: #4CAF50; color: white; }
        .btn-end { background: #f44336; color: white; }
        .btn-action { background: #2196F3; color: white; }
        .btn-cloud { background: #673AB7; color: white; margin-top: 20px; }
        input { width: 100%; padding: 12px; font-size: 1.1rem; border-radius: 8px; border: 2px solid #ccc; box-sizing: border-box; margin: 8px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.8rem; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
    </style>
</head>
<body>

<div id="app-card">
    <div class="version-tag">Versio 3.3 üü†</div>
    <div id="tyoaika-kello" style="display:none;">00:00:00</div>
    <div id="ui-content"></div>
</div>

<script>
let tyoaikaInterval;
let paivanKortit = JSON.parse(localStorage.getItem('sarmaus_historia')) || [];
let aloitusAikaleima = localStorage.getItem('aloitus_aikaleima');

function tallennaMuistiin() {
    localStorage.setItem('sarmaus_historia', JSON.stringify(paivanKortit));
}

function paivitaKello() {
    if (!aloitusAikaleima) return;
    const nyt = new Date().getTime();
    const erotus = Math.floor((nyt - aloitusAikaleima) / 1000);
    
    const h = Math.floor(erotus / 3600).toString().padStart(2, '0');
    const m = Math.floor((erotus % 3600) / 60).toString().padStart(2, '0');
    const s = (erotus % 60).toString().padStart(2, '0');
    document.getElementById('tyoaika-kello').innerText = `${h}:${m}:${s}`;
}

function naytaAloitus() {
    document.getElementById('tyoaika-kello').style.display = "none";
    let historiaHtml = paivanKortit.length > 0 ? `
        <h3>P√§iv√§n historia</h3>
        <table><tr><th>ID</th><th>Kesto</th></tr>` + 
        paivanKortit.map(k => `<tr><td>${k.id}</td><td>${k.kesto}</td></tr>`).join('') + 
        `</table>
        <button class="btn-cloud" onclick="lahetaPilveen()">L√ÑHET√Ñ PILVEEN ‚òÅÔ∏è</button>
        <button style="background:#777; color:white;" onclick="nollaaHistoria()">TYHJENN√Ñ ‚ö†Ô∏è</button>` : "";

    document.getElementById('ui-content').innerHTML = `
        <h1>S√§rm√§ys Pro</h1>
        <button class="btn-start" onclick="aloitaVuoro()">ALOITA TY√ñVUORO üöÄ</button>
        ${historiaHtml}
    `;
}

function aloitaVuoro() {
    aloitusAikaleima = new Date().getTime();
    localStorage.setItem('aloitus_aikaleima', aloitusAikaleima);
    
    document.getElementById('tyoaika-kello').style.display = "block";
    tyoaikaInterval = setInterval(paivitaKello, 1000);
    new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
    naytaSkannaus();
}

function naytaSkannaus() {
    document.getElementById('ui-content').innerHTML = `
        <h2>Kortti k√§ynniss√§ ‚ö°</h2>
        <input type="number" id="id-input" placeholder="Sy√∂t√§ ID" autofocus>
        <button class="btn-action" onclick="tallennaKortti()">TALLENNA KORTTI ‚úÖ</button>
        <button class="btn-end" onclick="lopetaVuoro()">LOPETA VUORO üèÅ</button>
    `;
}

function tallennaKortti() {
    const id = document.getElementById('id-input').value;
    if(!id) return;
    const kesto = document.getElementById('tyoaika-kello').innerText;
    paivanKortit.push({ id, kesto, pvm: new Date().toLocaleDateString() });
    tallennaMuistiin();
    alert(`Kortti ${id} tallennettu!`);
    document.getElementById('id-input').value = "";
}

function lopetaVuoro() {
    if(confirm("Lopetetaanko vuoro?")) {
        clearInterval(tyoaikaInterval);
        localStorage.removeItem('aloitus_aikaleima');
        aloitusAikaleima = null;
        naytaAloitus();
    }
}

// --- GOOGLE SHEETS L√ÑHETYS ---
function lahetaPilveen() {
    alert("L√§hetet√§√§n " + paivanKortit.length + " korttia pilveen...");
    // T√§h√§n tulee my√∂hemmin fetch-kutsu Google Scriptiin
}

// Tarkistetaan onko vuoro j√§√§nyt p√§√§lle
if (aloitusAikaleima) {
    document.getElementById('tyoaika-kello').style.display = "block";
    tyoaikaInterval = setInterval(paivitaKello, 1000);
    naytaSkannaus();
} else {
    naytaAloitus();
}
</script>
</body>
</html>
