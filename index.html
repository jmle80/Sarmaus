<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S√§rm√§ys Pro v3.9.7</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        .version-tag { color: #ff8c00; font-weight: bold; padding: 10px; font-size: 0.8rem; }
        body { font-family: sans-serif; text-align: center; padding: 10px; background: #f0f2f5; }
        
        .mittari-alue { display: flex; justify-content: space-around; background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .mittari { flex: 1; }
        .mittari-arvo { font-family: monospace; font-size: 1.4rem; font-weight: bold; color: #007bff; }
        .mittari-otsikko { font-size: 0.8rem; color: #666; text-transform: uppercase; }

        #tyoaika-display { font-family: monospace; font-size: 2rem; margin: 10px 0; color: #333; }
        
        #reader { width: 300px !important; height: 180px !important; margin: 10px auto; border-radius: 12px; overflow: hidden; background: #000; border: 3px solid #ccc; }
        .lomake-ikkuna { display: none; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-align: left; }
        
        input, select { width: 100%; padding: 12px; box-sizing: border-box; font-size: 1.1rem; border-radius: 8px; border: 2px solid #ddd; margin-bottom: 10px; }
        button { width: 100%; padding: 20px; font-size: 1.2rem; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; }
        .btn-aloita { background: #28a745; color: white; }
        .btn-tallenna { background: #007bff; color: white; }
        .btn-lopeta { background: #dc3545; color: white; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="version-tag">Versio 3.9.7 üü†</div>

    <div class="mittari-alue">
        <div class="mittari">
            <div class="mittari-otsikko">Vuoron joutuisuus</div>
            <div id="vuoro-joutuisuus" class="mittari-arvo">---</div>
        </div>
        <div class="mittari" style="border-left: 1px solid #eee;">
            <div class="mittari-otsikko">Jakson joutuisuus</div>
            <div id="jakso-joutuisuus" class="mittari-arvo">---</div>
        </div>
    </div>

    <div id="tyoaika-display">00:00:00</div>

    <div id="skannaus-alue" style="display:none;">
        <div id="reader"></div>
        <input type="tel" id="id-syotto" placeholder="Sy√∂t√§ ID (6 numeroa)" maxlength="6" oninput="tarkistaId(this.value)">
        <div id="laji-lisa-alue" style="display:none; margin-top:10px;">
            <input type="tel" id="laji-syotto" placeholder="Sy√∂t√§ tai skannaa laji">
        </div>
        <button class="btn-lopeta" onclick="lopetaVuoro()">LOPETA VUORO üèÅ</button>
    </div>

    <div id="vaihelomake" class="lomake-ikkuna">
        <h3 style="margin-top:0;">‚è±Ô∏è Kirjaa ajat</h3>
        <input type="tel" id="asetusaika" placeholder="1. Asetusaika (min)">
        <input type="tel" id="taivutusaika" placeholder="2. Taivutusaika (min.sek)">
        <select id="muu-vaihe-valikko" onchange="document.getElementById('muu-vaihe-nimi').value='';">
            </select>
        <input type="text" id="muu-vaihe-nimi" placeholder="Tai kirjoita uusi vaihe" oninput="document.getElementById('muu-vaihe-valikko').value='';">
        <input type="tel" id="muu-vaihe-aika" placeholder="3. Muun vaiheen aika (min.sek)">
        <button class="btn-tallenna" onclick="tallennaKaikki()">TALLENNA KORTTI ‚úÖ</button>
    </div>

    <button id="aloita-nappi" class="btn-aloita" onclick="aloitaVuoro()">ALOITA TY√ñVUORO üöÄ</button>

<script>
    let aloitusAikaleima = null;
    let kelloInterval = null;
    let html5QrCode = null;
    let nykyinenID = "";
    let nykyinenLaji = "";
    let korttejaTehty = 0;

    let jaksoData = JSON.parse(localStorage.getItem('sarmaysJakso')) || { tavoiteMin: 0, todellisetSek: 0 };
    let vuoroTavoiteMin = 0;

    function aloitaVuoro() {
        let syote = prompt("Aloitusaika (HH:MM) tai tyhj√§:", "");
        if (syote === null) return;
        
        // Alun h√§lytys√§√§ni
        new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play().catch(()=>{});
        
        aloitusAikaleima = new Date().getTime();
        document.getElementById('aloita-nappi').style.display = "none";
        document.getElementById('skannaus-alue').style.display = "block";
        
        paivitaNaytto();
        // P√§ivitet√§√§n automaattisesti minuutin v√§lein
        kelloInterval = setInterval(paivitaNaytto, 60000); 
        kaynnistaSkanneri();
    }

    function muunnaMinuuteiksi(val) {
        if (!val) return 0;
        let osat = val.toString().replace(',', '.').split('.');
        let min = parseInt(osat[0]) || 0;
        let sek = parseInt(osat[1]) || 0;
        return min + (sek / 60);
    }

    function tallennaKaikki() {
        const asetus = parseFloat(document.getElementById('asetusaika').value) || 0;
        const taivutus = muunnaMinuuteiksi(document.getElementById('taivutusaika').value);
        const muuAika = muunnaMinuuteiksi(document.getElementById('muu-vaihe-aika').value);
        
        vuoroTavoiteMin += (asetus + taivutus + muuAika);
        korttejaTehty++;

        // P√§ivitet√§√§n joutuisuus heti tallennuksen j√§lkeen
        paivitaNaytto();

        // Nollaus ja paluu skannaukseen
        nykyinenID = ""; nykyinenLaji = "";
        document.getElementById('id-syotto').value = "";
        document.getElementById('id-syotto').disabled = false;
        document.getElementById('laji-syotto').value = "";
        document.getElementById('laji-lisa-alue').style.display = "none";
        document.getElementById('vaihelomake').style.display = "none";
        document.getElementById('skannaus-alue').style.display = "block";
    }

    function paivitaNaytto() {
        if (!aloitusAikaleima) return;

        let nytMs = new Date().getTime();
        let kulunutSek = Math.floor((nytMs - aloitusAikaleima) / 1000);
        let kulunutTunnit = kulunutSek / 3600;

        document.getElementById('tyoaika-display').innerText = new Date(kulunutSek * 1000).toISOString().substr(11, 8);

        // Lasketaan joutuisuus vain jos ensimm√§inen kortti on tehty
        if (korttejaTehty > 0) {
            let vuoroJout = (vuoroTavoiteMin / 60) / kulunutTunnit;
            document.getElementById('vuoro-joutuisuus').innerText = vuoroJout.toFixed(2);

            let jaksoTunnitTotal = (jaksoData.todellisetSek + kulunutSek) / 3600;
            let jaksoJout = ((jaksoData.tavoiteMin + vuoroTavoiteMin) / 60) / jaksoTunnitTotal;
            document.getElementById('jakso-joutuisuus').innerText = jaksoJout.toFixed(2);
        }
    }

    function lopetaVuoro() {
        if (confirm("Lopetetaanko vuoro?")) {
            let kulunutSek = Math.floor((new Date().getTime() - aloitusAikaleima) / 1000);
            jaksoData.tavoiteMin += vuoroTavoiteMin;
            jaksoData.todellisetSek += kulunutSek;
            localStorage.setItem('sarmaysJakso', JSON.stringify(jaksoData));
            location.reload();
        }
    }

    // Skanneri- ja ID-logiikka v3.9.5:st√§...
    function tarkistaId(val) {
        if (/^\d{6}$/.test(val)) {
            nykyinenID = val;
            document.getElementById('id-syotto').disabled = true;
            document.getElementById('laji-lisa-alue').style.display = "block";
            new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play().catch(()=>{});
        }
    }
</script>
</body>
</html>
