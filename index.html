<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Työvuoroseuranta</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Versiunumero */
        #version-display {
            color: #d32f2f;
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 10px;
            display: block;
        }

        h1, h2, h3 {
            text-align: center;
            color: #2c3e50;
        }

        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        /* Neutraali status-paneeli */
        .status-panel {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .clock {
            font-size: 2em;
            font-family: 'Courier New', Courier, monospace;
            margin: 10px 0;
            font-weight: bold;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }

        /* Napit */
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            font-weight: bold;
        }

        .btn-start { background-color: #4CAF50; color: white; }
        .btn-start:hover { background-color: #45a049; }

        .btn-end { background-color: #f44336; color: white; }
        .btn-end:hover { background-color: #d32f2f; }

        .btn-scan { background-color: #2196F3; color: white; }
        .btn-scan:hover { background-color: #1976D2; }

        .btn-reset { background-color: #ff9800; color: white; }
        .btn-reset:hover { background-color: #f57c00; }

        .btn-backup { background-color: #607d8b; color: white; }
        .btn-backup:hover { background-color: #455a64; }

        /* Skanneri */
        #reader {
            width: 100%;
            margin-top: 20px;
            display: none;
            background-color: black;
            position: relative;
        }

        /* Poistetaan vihreä raita ja dashboard */
        #reader__scan_region {
            border: none !important;
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.4) !important;
            background: transparent !important;
        }
        #reader__dashboard_section_csr span {
            display: none !important;
        }

        /* --- UUSI HISTORIA ULKOASU (V3.0) --- */
        .history-date-group {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .history-date-header {
            background-color: #e9ecef;
            padding: 10px 15px;
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
            border-bottom: 1px solid #ddd;
        }

        table.day-table {
            width: 100%;
            border-collapse: collapse;
        }

        table.day-table th, table.day-table td {
            padding: 10px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        table.day-table th {
            background-color: #fff;
            color: #555;
            font-size: 0.9em;
            text-transform: uppercase;
            border-bottom: 2px solid #ddd;
        }

        table.day-table tr:last-child td {
            border-bottom: none;
        }

        /* Mobiilioptimointi historialle */
        @media screen and (max-width: 600px) {
            table.day-table, table.day-table thead, table.day-table tbody, table.day-table th, table.day-table td, table.day-table tr {
                display: block;
            }
            table.day-table thead {
                display: none; /* Piilotetaan otsikot mobiilissa tilan säästämiseksi */
            }
            table.day-table tr {
                margin-bottom: 10px;
                border-bottom: 2px solid #f0f0f0;
                padding-bottom: 10px;
            }
            table.day-table td {
                border: none;
                padding: 5px 15px;
                position: relative;
                padding-left: 50%;
            }
            table.day-table td:before {
                position: absolute;
                top: 5px;
                left: 15px;
                width: 45%;
                white-space: nowrap;
                font-weight: bold;
                content: attr(data-label);
                color: #777;
            }
        }
    </style>
</head>
<body>

    <div id="version-display">Versio 3.0 (Ryhmitelty historia)</div>

    <div class="container">
        <h1>Työvuoroseuranta</h1>

        <div class="status-panel">
            <div>Nykyinen tila: <span id="status-text" style="font-weight:bold; color:red;">Ei vuoroa</span></div>
            <div id="live-clock" class="clock">00:00:00</div>
            <div id="duration-timer" style="font-size: 1.2em; color: #555;">Kesto: 00:00:00</div>
        </div>

        <div class="input-group">
            <label for="card-number">Kortin numero (6 numeroa):</label>
            <input type="text" id="card-number" placeholder="123456" maxlength="6">
        </div>

        <div class="input-group">
            <label for="type-mark">Lajimerkki (Kirjaimet -> ISOIKSI):</label>
            <input type="text" id="type-mark" placeholder="ABC">
        </div>

        <div id="reader"></div>

        <div class="btn-group">
            <button class="btn-start" onclick="startShift()">Aloita vuoro</button>
            <button class="btn-end" onclick="endShift()">Lopeta vuoro</button>
            <button class="btn-scan" onclick="toggleScanner()">Skannaa viivakoodi</button>
        </div>
        
        <div class="btn-group">
             <button class="btn-backup" onclick="downloadBackup()">Lataa varmuuskopio (JSON)</button>
             <input type="file" id="restore-file" style="display:none" onchange="restoreBackup(this)">
             <button class="btn-backup" onclick="document.getElementById('restore-file').click()">Palauta varmuuskopio</button>
             <button class="btn-reset" onclick="clearHistory()">Nollaa historia</button>
        </div>
    </div>

    <div class="container">
        <h2>Historia</h2>
        <div id="history-container"></div>
    </div>

    <script>
        // --- MUUTTUJAT ---
        let shiftStartTime = null;
        let shiftTimerInterval = null;
        let html5QrCode = null;
        let isScanning = false;
        
        // Ääniefekti
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBeep() {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.type = 'sine';
            oscillator.frequency.value = 880; 
            gainNode.gain.value = 0.1;
            oscillator.start();
            setTimeout(() => { oscillator.stop(); }, 200); 
        }

        // --- ALUSTUS ---
        window.onload = function() {
            updateLiveClock();
            setInterval(updateLiveClock, 1000);
            loadHistory(); // Lataa uusi ryhmitelty historia
            
            const savedStart = localStorage.getItem('currentShiftStart');
            if (savedStart) {
                shiftStartTime = new Date(savedStart);
                startTimerOnly();
                document.getElementById('status-text').textContent = "Vuoro käynnissä";
                document.getElementById('status-text').style.color = "green";
                
                document.getElementById('card-number').value = localStorage.getItem('currentCard') || '';
                document.getElementById('type-mark').value = localStorage.getItem('currentType') || '';
            }

            document.getElementById('card-number').addEventListener('input', validateCardNumber);
            document.getElementById('type-mark').addEventListener('input', forceUpperCase);
        };

        // --- LOGIIKKA ---
        function updateLiveClock() {
            const now = new Date();
            document.getElementById('live-clock').textContent = now.toLocaleTimeString('fi-FI');
        }

        function startTimerOnly() {
            if (shiftTimerInterval) clearInterval(shiftTimerInterval);
            shiftTimerInterval = setInterval(() => {
                if (!shiftStartTime) return;
                const now = new Date();
                const diff = now - shiftStartTime;
                const diffDate = new Date(diff);
                const hours = diffDate.getUTCHours().toString().padStart(2, '0');
                const minutes = diffDate.getUTCMinutes().toString().padStart(2, '0');
                const seconds = diffDate.getUTCSeconds().toString().padStart(2, '0');
                document.getElementById('duration-timer').textContent = `Kesto: ${hours}:${minutes}:${seconds}`;
            }, 1000);
        }

        function validateCardNumber(e) {
            let value = e.target.value.replace(/[^0-9]/g, '');
            if (value.length > 6) value = value.slice(0, 6);
            e.target.value = value;
            if (shiftStartTime) localStorage.setItem('currentCard', value);
        }

        function forceUpperCase(e) {
            let value = e.target.value.toUpperCase();
            e.target.value = value;
            if (shiftStartTime) localStorage.setItem('currentType', value);
        }

        function startShift() {
            if (shiftStartTime) {
                alert("Vuoro on jo käynnissä!");
                return;
            }
            playBeep();
            shiftStartTime = new Date();
            localStorage.setItem('currentShiftStart', shiftStartTime);
            localStorage.setItem('currentCard', document.getElementById('card-number').value);
            localStorage.setItem('currentType', document.getElementById('type-mark').value);

            document.getElementById('status-text').textContent = "Vuoro käynnissä";
            document.getElementById('status-text').style.color = "green";
            startTimerOnly();
        }

        function endShift() {
            if (!shiftStartTime) {
                alert("Ei käynnissä olevaa vuoroa.");
                return;
            }
            const cardNumber = document.getElementById('card-number').value;
            if (cardNumber.length !== 6) {
                alert("Kortin numeron pitää olla tasan 6 numeroa ennen lopetusta!");
                return;
            }

            const endTime = new Date();
            const durationMs = endTime - shiftStartTime;
            const diffDate = new Date(durationMs);
            const durationStr = `${diffDate.getUTCHours().toString().padStart(2, '0')}:${diffDate.getUTCMinutes().toString().padStart(2, '0')}:${diffDate.getUTCSeconds().toString().padStart(2, '0')}`;

            const entry = {
                date: shiftStartTime.toLocaleDateString('fi-FI'), // Käytetään ryhmittelyyn
                start: shiftStartTime.toLocaleTimeString('fi-FI'),
                end: endTime.toLocaleTimeString('fi-FI'),
                duration: durationStr,
                card: cardNumber,
                type: document.getElementById('type-mark').value
            };

            saveToHistory(entry);
            
            shiftStartTime = null;
            clearInterval(shiftTimerInterval);
            document.getElementById('duration-timer').textContent = "Kesto: 00:00:00";
            document.getElementById('status-text').textContent = "Ei vuoroa";
            document.getElementById('status-text').style.color = "red";
            localStorage.removeItem('currentShiftStart');
            localStorage.removeItem('currentCard');
            localStorage.removeItem('currentType');
            document.getElementById('card-number').value = "";
            document.getElementById('type-mark').value = "";
        }

        // --- UUSITTU HISTORIAN KÄSITTELY (V3.0) ---
        function saveToHistory(entry) {
            let history = JSON.parse(localStorage.getItem('shiftHistory') || "[]");
            history.push(entry);
            localStorage.setItem('shiftHistory', JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            let history = JSON.parse(localStorage.getItem('shiftHistory') || "[]");
            const container = document.getElementById('history-container');
            container.innerHTML = ""; // Tyhjennetään näkymä

            // Jos historia on tyhjä
            if (history.length === 0) {
                container.innerHTML = "<p style='text-align:center; color:#777;'>Ei merkintöjä.</p>";
                return;
            }

            // 1. Ryhmitellään data päivämäärän mukaan
            // Käytetään objektia: { "24.1.2026": [entry1, entry2], ... }
            const groupedData = {};
            
            // Järjestetään historia ensin uusimmat ensin, jotta ryhmätkin tulevat oikein
            // Huom: Oletetaan että uusin on lopussa, joten käännetään loopissa tai tässä
            // Tehdään niin että uusimmat merkinnät ovat ylimpänä
            const reversedHistory = history.slice().reverse();

            reversedHistory.forEach(entry => {
                if (!groupedData[entry.date]) {
                    groupedData[entry.date] = [];
                }
                groupedData[entry.date].push(entry);
            });

            // 2. Luodaan HTML jokaiselle päivälle
            // Object.keys ei takaa järjestystä, mutta koska lisäsimme ne järjestyksessä, se usein toimii.
            // Varmuuden vuoksi käydään läpi unique dates listaa, joka on kerätty reversedHistorysta.
            const uniqueDates = [...new Set(reversedHistory.map(item => item.date))];

            uniqueDates.forEach(date => {
                const dayEntries = groupedData[date];

                // Luodaan päivä-container
                const dayGroup = document.createElement('div');
                dayGroup.className = 'history-date-group';

                // Otsikko
                const header = document.createElement('div');
                header.className = 'history-date-header';
                header.textContent = date;
                dayGroup.appendChild(header);

                // Taulukko
                const table = document.createElement('table');
                table.className = 'day-table';
                
                // Sarakemerkinnät
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th style="width: 30%">Kortin numero</th>
                        <th style="width: 20%">Lajimerkki</th>
                        <th style="width: 50%">Aika</th>
                    </tr>
                `;
                table.appendChild(thead);

                // Rivit
                const tbody = document.createElement('tbody');
                dayEntries.forEach(entry => {
                    const row = document.createElement('tr');
                    // Yhdistetään Aika-tieto (Aloitus - Lopetus (Kesto))
                    const timeString = `${entry.start} - ${entry.end} (${entry.duration})`;

                    row.innerHTML = `
                        <td data-label="Kortin numero">${entry.card}</td>
                        <td data-label="Lajimerkki">${entry.type}</td>
                        <td data-label="Aika">${timeString}</td>
                    `;
                    tbody.appendChild(row);
                });
                table.appendChild(tbody);
                
                dayGroup.appendChild(table);
                container.appendChild(dayGroup);
            });
        }

        function clearHistory() {
            if (confirm("Haluatko varmasti nollata koko jakson historian? (Do you really want to reset the entire period history?)")) {
                localStorage.removeItem('shiftHistory');
                loadHistory();
            }
        }

        function downloadBackup() {
            const history = localStorage.getItem('shiftHistory') || "[]";
            const blob = new Blob([history], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "tyovuorot_backup_" + new Date().toISOString().slice(0,10) + ".json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function restoreBackup(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        if(confirm("Tämä korvaa nykyisen historian. Oletko varma?")) {
                            localStorage.setItem('shiftHistory', JSON.stringify(data));
                            loadHistory();
                            alert("Varmuuskopio palautettu onnistuneesti!");
                        }
                    } else { alert("Virheellinen tiedostomuoto."); }
                } catch (err) { alert("Virhe tiedoston luvussa: " + err.message); }
            };
            reader.readAsText(file);
        }

        function toggleScanner() {
            const readerElem = document.getElementById('reader');
            if (isScanning) {
                if (html5QrCode) {
                    html5QrCode.stop().then(() => {
                        readerElem.style.display = "none";
                        isScanning = false;
                        document.querySelector('.btn-scan').textContent = "Skannaa viivakoodi";
                    }).catch(err => { console.error("Stop failed", err); });
                }
            } else {
                readerElem.style.display = "block";
                if (!html5QrCode) { html5QrCode = new Html5Qrcode("reader"); }
                const config = { fps: 10, qrbox: { width: 300, height: 150 }, aspectRatio: 1.777778 };
                html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
                .then(() => {
                    isScanning = true;
                    document.querySelector('.btn-scan').textContent = "Sulje kamera";
                }).catch(err => {
                    alert("Kameran käynnistys epäonnistui: " + err);
                    readerElem.style.display = "none";
                });
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            playBeep();
            document.getElementById('card-number').value = decodedText;
            validateCardNumber({ target: document.getElementById('card-number') });
            toggleScanner();
        }
    </script>
</body>
</html>
