<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S√§rm√§ys Pro v3.9.5</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        .version-tag { color: #ff8c00; font-weight: bold; padding: 10px; font-size: 0.8rem; }
        body { font-family: sans-serif; text-align: center; padding: 10px; background: #f0f2f5; }
        #tyoaika-display { font-family: monospace; font-size: 2rem; margin: 10px 0; }
        
        #reader { width: 300px !important; height: 180px !important; margin: 10px auto; border-radius: 12px; overflow: hidden; background: #000; border: 3px solid #ccc; }
        
        .lomake-ikkuna { display: none; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-align: left; margin-top: 10px; }
        .kentta-ryhma { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #444; }
        
        input, select { width: 100%; padding: 12px; box-sizing: border-box; font-size: 1.1rem; border-radius: 8px; border: 2px solid #ddd; }
        input:focus { border-color: #007bff; outline: none; }

        button { width: 100%; padding: 20px; font-size: 1.2rem; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-aloita { background: #28a745; color: white; }
        .btn-tallenna { background: #007bff; color: white; }
        .btn-lopeta { background: #dc3545; color: white; }
    </style>
</head>
<body>
    <div class="version-tag">Versio 3.9.5 üü†</div>
    <div id="tyoaika-display">00:00:00</div>

    <div id="skannaus-alue" style="display:none;">
        <div id="ohje" style="font-weight:bold; margin-bottom:10px;">Skannaa tai sy√∂t√§ ID üî¢</div>
        <div id="reader"></div>
        <input type="tel" id="id-syotto" placeholder="ID (6 numeroa)" maxlength="6" oninput="tarkistaId(this.value)">
        <div id="laji-lisa-alue" style="display:none; margin-top:10px;">
            <input type="tel" id="laji-syotto" placeholder="Sy√∂t√§ tai skannaa laji">
        </div>
        <button class="btn-lopeta" onclick="lopetaVuoro()">LOPETA VUORO üèÅ</button>
    </div>

    <div id="vaihelomake" class="lomake-ikkuna">
        <h3 style="margin-top:0;">Ty√∂vaiheen tiedot ‚è±Ô∏è</h3>
        
        <div class="kentta-ryhma">
            <label>1. Asetusaika (min):</label>
            <input type="tel" id="asetusaika" placeholder="esim. 5">
        </div>

        <div class="kentta-ryhma">
            <label>2. Taivutusaika (min.sek):</label>
            <input type="tel" id="taivutusaika" placeholder="esim. 2.26">
        </div>

        <div class="kentta-ryhma">
            <label>3. Muut ty√∂vaiheet:</label>
            <select id="muu-vaihe-valikko" onchange="valikkoMuuttui()">
                </select>
            <input type="text" id="muu-vaihe-nimi" placeholder="Kirjoita uusi vaihe" style="margin-top:10px;" oninput="tekstiMuuttui()">
            <input type="tel" id="muu-vaihe-aika" placeholder="Vaiheen aika (min.sek)" style="margin-top:10px;">
        </div>

        <button class="btn-tallenna" onclick="tallennaKaikki()">TALLENNA KORTTI ‚úÖ</button>
    </div>

    <button id="aloita-nappi" class="btn-aloita" onclick="aloitaVuoro()">ALOITA TY√ñVUORO üöÄ</button>

<script>
    let aloitusAikaleima = null;
    let kelloInterval = null;
    let html5QrCode = null;
    let tehdytKortit = [];
    let nykyinenID = "";
    let nykyinenLaji = "";

    // Ladataan suosituimmat vaiheet muistista
    let vaiheTilastot = JSON.parse(localStorage.getItem('sarmaysVaiheet')) || {
        "Hionta": 1,
        "Puhdistus": 1,
        "Pakkaus": 1
    };

    function paivitaVaiheValikko() {
        const valikko = document.getElementById('muu-vaihe-valikko');
        valikko.innerHTML = '<option value="">Valitse suosituista...</option>';
        
        // J√§rjestet√§√§n vaiheet k√§yt√∂n mukaan
        const jarjestetyt = Object.entries(vaiheTilastot)
            .sort((a, b) => b[1] - a[1]);

        jarjestetyt.forEach(([nimi, kerrat]) => {
            const opt = document.createElement('option');
            opt.value = nimi;
            opt.innerText = nimi;
            valikko.appendChild(opt);
        });
        
        const muuOpt = document.createElement('option');
        muuOpt.value = "KIRJOITA_UUSI";
        muuOpt.innerText = "--- Kirjoita uusi ---";
        valikko.appendChild(muuOpt);
    }

    function tekstiMuuttui() {
        // Jos kirjoitetaan, nollataan valikko
        document.getElementById('muu-vaihe-valikko').value = "";
    }

    function valikkoMuuttui() {
        // Jos valitaan valikosta, tyhjennet√§√§n tekstikentt√§
        if (document.getElementById('muu-vaihe-valikko').value !== "KIRJOITA_UUSI") {
            document.getElementById('muu-vaihe-nimi').value = "";
        }
    }

    function aloitaVuoro() {
        let syote = prompt("Aloitusaika (HH:MM):", "");
        if (syote === null) return;
        new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play().catch(()=>{});
        aloitusAikaleima = new Date().getTime();
        document.getElementById('aloita-nappi').style.display = "none";
        document.getElementById('skannaus-alue').style.display = "block";
        kelloInterval = setInterval(paivitaKello, 1000);
        paivitaVaiheValikko();
        kaynnistaSkanneri();
    }

    function kaynnistaSkanneri() {
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 200 }, (txt) => {
            if (!nykyinenID) tarkistaId(txt);
            else if (!nykyinenLaji) siirryLomakkeeseen(txt);
        });
    }

    function tarkistaId(val) {
        if (/^\d{6}$/.test(val)) {
            nykyinenID = val;
            document.getElementById('id-syotto').value = val;
            document.getElementById('id-syotto').disabled = true;
            document.getElementById('laji-lisa-alue').style.display = "block";
            document.getElementById('ohje').innerText = "Skannaa tai sy√∂t√§ laji üè∑Ô∏è";
        }
    }

    document.getElementById('laji-syotto').addEventListener('keydown', (e) => {
        if(e.key === 'Enter') siirryLomakkeeseen(e.target.value);
    });

    function siirryLomakkeeseen(laji) {
        if (!laji) return;
        nykyinenLaji = laji;
        document.getElementById('skannaus-alue').style.display = "none";
        document.getElementById('vaihelomake').style.display = "block";
    }

    function tallennaKaikki() {
        let valittuVaihe = document.getElementById('muu-vaihe-valikko').value;
        let kirjoitettuVaihe = document.getElementById('muu-vaihe-nimi').value.trim();
        let lopullinenVaihe = kirjoitettuVaihe || valittuVaihe;

        if (lopullinenVaihe && lopullinenVaihe !== "KIRJOITA_UUSI") {
            // P√§ivitet√§√§n tilastot
            vaiheTilastot[lopullinenVaihe] = (vaiheTilastot[lopullinenVaihe] || 0) + 1;
            localStorage.setItem('sarmaysVaiheet', JSON.stringify(vaiheTilastot));
        }

        const data = {
            id: nykyinenID,
            laji: nykyinenLaji,
            asetus: document.getElementById('asetusaika').value,
            taivutus: document.getElementById('taivutusaika').value.replace(',', '.'),
            muuVaihe: lopullinenVaihe,
            muuAika: document.getElementById('muu-vaihe-aika').value.replace(',', '.'),
            kello: new Date().toLocaleTimeString()
        };

        tehdytKortit.push(data);
        
        // Nollaus
        nykyinenID = ""; nykyinenLaji = "";
        document.getElementById('id-syotto').value = "";
        document.getElementById('id-syotto').disabled = false;
        document.getElementById('laji-syotto').value = "";
        document.getElementById('laji-lisa-alue').style.display = "none";
        
        document.getElementById('asetusaika').value = "";
        document.getElementById('taivutusaika').value = "";
        document.getElementById('muu-vaihe-aika').value = "";
        document.getElementById('muu-vaihe-nimi').value = "";

        paivitaVaiheValikko(); // P√§ivitet√§√§n lista uutta korttia varten
        document.getElementById('vaihelomake').style.display = "none";
        document.getElementById('skannaus-alue').style.display = "block";
    }

    function paivitaKello() {
        let sek = Math.floor((new Date().getTime() - aloitusAikaleima) / 1000);
        document.getElementById('tyoaika-display').innerText = new Date(sek * 1000).toISOString().substr(11, 8);
    }

    function lopetaVuoro() {
        if (confirm("Lopetetaanko? Kortteja: " + tehdytKortit.length)) location.reload();
    }
</script>
</body>
</html>
