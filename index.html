<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Press Brake Pro v2.25 - SCANNER FIX</title>
    
    <script>
        // Määritellään tila globaalisti heti, jotta mikään ei voi estää tätä
        var appState = { kaynnissa: false, aloitusAika: 0, kuitatutPankki: 0, nykyinenTila: null, erikoistilaAloitus: 0, tarkennus: "" };
        
        // Yritetään ladata tallennettu tila heti
        try {
            var saved = localStorage.getItem('pb_state_final');
            if (saved) appState = JSON.parse(saved);
        } catch(e) { console.log("Ei tallennettua tilaa"); }

        // TÄMÄ FUNKTIO ON NYT TÄYSIN ERISTETTY JA TURVASSA
        function VAIHDA_VUORO() {
            try {
                // Varmistus
                if (!appState) {
                     appState = { kaynnissa: false, aloitusAika: 0, kuitatutPankki: 0, nykyinenTila: null, erikoistilaAloitus: 0, tarkennus: "" };
                }

                if (!appState.kaynnissa) {
                    if (confirm("Aloitetaanko uusi vuoro nyt?")) {
                        // Soita ääni jos onnistuu
                        try { new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFRm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YT1vT19vT18=').play().catch(function(e){}); } catch(e){}
                        
                        appState.aloitusAika = Date.now();
                        appState.kaynnissa = true;
                        appState.kuitatutPankki = 0;
                        appState.nykyinenTila = null;
                        
                        // Nollataan kentät, jos elementit on ladattu
                        if(document.getElementById('v-kortti')) {
                            ['kortti','lajike','asetus','taivutus','muut'].forEach(function(id){ 
                                document.getElementById('v-'+id).innerText = "-"; 
                                localStorage.setItem('pb_field_' + id, "-");
                            });
                        }
                        
                        tallennaTilaCore();
                        if(typeof paivitaUI === 'function') paivitaUI();
                        if(typeof paivitaAikajana === 'function') paivitaAikajana();
                    }
                } else {
                    if (confirm("Haluatko varmasti lopettaa vuoron?")) {
                        appState.kaynnissa = false;
                        tallennaTilaCore();
                        location.reload();
                    }
                }
            } catch (e) {
                alert("Virhe vuoron vaihdossa: " + e.message);
            }
        }

        function tallennaTilaCore() {
            localStorage.setItem('pb_state_final', JSON.stringify(appState));
        }

        function hataNollaus() {
            if(confirm("Tämä poistaa kaiken tiedon ja korjaa jumiutuneen
