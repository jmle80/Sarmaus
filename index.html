<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S√§rm√§ys Pro v3.9.0</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        .version-tag { color: #ff8c00; font-weight: bold; padding: 10px; font-size: 0.8rem; }
        body { font-family: sans-serif; text-align: center; padding: 10px; background: #f0f2f5; }
        #tyoaika-display { font-family: monospace; font-size: 2rem; margin: 10px 0; }
        
        #reader { width: 300px !important; height: 180px !important; margin: 10px auto; border-radius: 12px; overflow: hidden; background: #000; }
        #reader video { object-fit: cover !important; width: 100% !important; height: 100% !important; }

        .virhe-ilmoitus { color: white; background: #dc3545; padding: 10px; border-radius: 8px; margin: 10px; display: none; animation: shake 0.5s; }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }

        #lajivalikko { display: none; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 10px; }
        .laji-nappi { background: #007bff; color: white; padding: 15px; margin: 5px; border-radius: 8px; border: none; font-weight: bold; width: 40%; }
        
        button { width: 100%; padding: 20px; font-size: 1.2rem; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; }
        .btn-aloita { background: #28a745; color: white; }
        .btn-lopeta { background: #dc3545; color: white; margin-top: 10px; }
        .btn-kasin { background: #6c757d; color: white; padding: 10px; font-size: 1rem; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="version-tag">Versio 3.9.0 üü†</div>
    <div id="tyoaika-display">00:00:00</div>

    <div id="tyo-alue" style="display:none;">
        <div id="reader"></div>
        <div id="virhe-ruutu" class="virhe-ilmoitus">‚ùå V√Ñ√ÑR√Ñ PITUUS! (Vain 6 numeroa)</div>
        
        <input type="text" id="id-naytto" readonly placeholder="Odotetaan skannausta..." 
               style="width:80%; padding:10px; margin:10px; font-size:1.2rem; text-align:center; border-radius:8px; border:1px solid #ccc;">
        
        <button class="btn-kasin" onclick="syotaKasin()">‚å®Ô∏è Sy√∂t√§ ID k√§sin</button>

        <div id="lajivalikko">
            <p>Valitse lajimerkki koodille <span id="valittu-id"></span>:</p>
            <button class="laji-nappi" onclick="tallennaKortti('Laji A')">Laji A</button>
            <button class="laji-nappi" onclick="tallennaKortti('Laji B')">Laji B</button>
            <button class="laji-nappi" onclick="tallennaKortti('Laji C')">Laji C</button>
            <button class="laji-nappi" onclick="tallennaKortti('Muu')">Muu</button>
        </div>
        
        <button class="btn-lopeta" onclick="lopetaVuoro()">LOPETA VUORO üèÅ</button>
    </div>

    <button id="aloita-nappi" class="btn-aloita" onclick="aloitaVuoro()">ALOITA TY√ñVUORO üöÄ</button>

<script>
    let aloitusAikaleima = null;
    let kelloInterval = null;
    let html5QrCode = null;
    let tehdytKortit = [];
    let viimeisinID = "";

    function aloitaVuoro() {
        let syote = prompt("Aloitusaika (HH:MM) tai tyhj√§:", "");
        if (syote === null) return;
        let nyt = kasitteleAika(syote);
        aloitusAikaleima = nyt.getTime();
        document.getElementById('aloita-nappi').style.display = "none";
        document.getElementById('tyo-alue').style.display = "block";
        kelloInterval = setInterval(paivitaKello, 1000);
        kaynnistaSkanneri();
    }

    function kaynnistaSkanneri() {
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 200 }, (txt) => {
            kasitteleSyote(txt);
        });
    }

    function syotaKasin() {
        let kasin = prompt("Sy√∂t√§ 6-numeroinen ID:");
        if (kasin) kasitteleSyote(kasin);
    }

    function kasitteleSyote(txt) {
        const virhe = document.getElementById('virhe-ruutu');
        // Puhdistetaan sy√∂te mahdollisista tyhjist√§
        txt = txt.trim();

        if (/^\d{6}$/.test(txt)) {
            virhe.style.display = "none";
            viimeisinID = txt;
            document.getElementById('id-naytto').value = "ID: " + txt;
            document.getElementById('valittu-id').innerText = txt;
            document.getElementById('lajivalikko').style.display = "block";
            new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play().catch(()=>{});
        } else {
            // Hyl√§t√§√§n ja n√§ytet√§√§n virhe
            virhe.style.display = "block";
            setTimeout(() => { virhe.style.display = "none"; }, 3000);
        }
    }

    function tallennaKortti(laji) {
        tehdytKortit.push({
            id: viimeisinID,
            laji: laji,
            kellonaika: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
        });
        document.getElementById('id-naytto').value = "";
        document.getElementById('lajivalikko').style.display = "none";
        viimeisinID = "";
    }

    // ... (Aiemmat lopetus- ja kellofunktiot s√§ilyv√§t ennallaan) ...
    function kasitteleAika(syote) {
        let nyt = new Date();
        if (syote && syote.trim() !== "") {
            let osat = syote.split(/[:.]/);
            if (osat.length >= 2) nyt.setHours(parseInt(osat[0]), parseInt(osat[1]), 0, 0);
        }
        return nyt;
    }

    function paivitaKello() {
        let erotusMs = new Date().getTime() - aloitusAikaleima;
        let sek = Math.floor(erotusMs / 1000);
        let h = Math.floor(sek / 3600).toString().padStart(2, '0');
        let m = Math.floor((sek % 3600) / 60).toString().padStart(2, '0');
        let s = (sek % 60).toString().padStart(2, '0');
        document.getElementById('tyoaika-display').innerText = `${h}:${m}:${s}`;
    }

    function lopetaVuoro() {
        if (!confirm("Haluatko lopettaa?")) return;
        let syote = prompt("Lopetusaika (HH:MM) tai tyhj√§:", "");
        // T√§h√§n tulee aiemmin sovittu raporttilogiikka
        alert("Vuoro lopetettu! Kortteja yhteens√§: " + tehdytKortit.length);
        location.reload();
    }
</script>
</body>
</html>
