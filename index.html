<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S√§rm√§ys Pro v3.9.9</title>
    <style>
        .version-tag { color: #ff8c00; font-weight: bold; padding: 10px; font-size: 0.8rem; }
        body { font-family: sans-serif; text-align: center; padding: 10px; background: #f0f2f5; margin: 0; }
        
        .mittari-alue { display: flex; justify-content: space-around; background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .mittari-arvo { font-family: monospace; font-size: 1.4rem; font-weight: bold; color: #007bff; }
        .mittari-otsikko { font-size: 0.8rem; color: #666; text-transform: uppercase; }

        #raportti-alue { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; overflow-y: auto; padding: 20px; box-sizing: border-box; text-align: left; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border-bottom: 1px solid #ddd; padding: 8px; font-size: 0.9rem; }
        
        input { width: 100%; padding: 12px; box-sizing: border-box; font-size: 1.1rem; border-radius: 8px; border: 2px solid #ddd; margin-bottom: 10px; }
        button { width: 100%; padding: 15px; font-size: 1.1rem; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 5px; }
        .btn-aloita { background: #28a745; color: white; padding: 25px; }
        .btn-tallenna { background: #007bff; color: white; }
        .btn-lopeta { background: #dc3545; color: white; margin-top: 20px; }
    </style>
</head>
<body onload="tarkistaTila()">
    <div class="version-tag">Versio 3.9.9 üü†</div>

    <div class="mittari-alue">
        <div class="mittari">
            <div class="mittari-otsikko">Vuoro</div>
            <div id="vuoro-joutuisuus" class="mittari-arvo">---</div>
        </div>
        <div class="mittari" style="border-left: 1px solid #eee;">
            <div class="mittari-otsikko">Jakso</div>
            <div id="jakso-joutuisuus" class="mittari-arvo">---</div>
        </div>
    </div>

    <div id="tyoaika-display" style="font-size: 2rem; font-family: monospace; margin: 10px 0;">00:00:00</div>

    <button id="aloita-nappi" class="btn-aloita" onclick="aloitaVuoro()">ALOITA TY√ñVUORO üöÄ</button>

    <div id="tyo-alue" style="display:none;">
        <button style="background:#6c757d; color:white;" onclick="naytaRaportti()">AVAA RAPORTTI üìä</button>
        
        <div id="skannaus-alue">
            <input type="text" id="id-syotto" placeholder="Sy√∂t√§ ID (6 numeroa)" oninput="tarkistaId(this.value); tallennaLuonnos()">
            <div id="laji-lisa-alue" style="display:none;">
                <input type="text" id="laji-syotto" placeholder="Sy√∂t√§ lajimerkki" oninput="tallennaLuonnos()">
            </div>
        </div>

        <div id="vaihelomake" style="display:none; text-align: left; background: white; padding: 15px; border-radius: 10px; margin-top:10px;">
            <label>Asetusaika (min):</label>
            <input type="number" id="asetusaika" oninput="tallennaLuonnos()">
            <label>Taivutusaika (min.sek):</label>
            <input type="text" id="taivutusaika" placeholder="esim. 2.30" oninput="tallennaLuonnos()">
            <label>Muu vaihe ja aika:</label>
            <input type="text" id="muu-vaihe-nimi" placeholder="Vaiheen nimi" oninput="tallennaLuonnos()">
            <input type="text" id="muu-vaihe-aika" placeholder="min.sek" oninput="tallennaLuonnos()">
            <button class="btn-tallenna" onclick="tallennaKortti()">TALLENNA KORTTI ‚úÖ</button>
        </div>

        <button class="btn-lopeta" onclick="lopetaVuoro()">LOPETA VUORO üèÅ</button>
    </div>

    <div id="raportti-alue">
        <h2>P√§iv√§n kortit üìù</h2>
        <table id="vuoro-taulukko">
            <thead><tr><th>ID</th><th>Laji</th><th>Min</th></tr></thead>
            <tbody></tbody>
        </table>
        <h2 style="margin-top:30px;">Palkkajakso üìÖ</h2>
        <div id="jakso-yhteenveto"></div>
        <button style="background:#333; color:white;" onclick="suljeRaportti()">SULJE RAPORTTI ‚úñÔ∏è</button>
        <button style="background:#ffc107; color:black; margin-top:20px;" onclick="nollaaKokoJakso()">NOLLAA JAKSON HISTORIA ‚ö†Ô∏è</button>
    </div>

<script>
    let aloitusAikaleima = null;
    let kelloInterval = null;
    let vuoroTavoiteMin = 0;
    let vuoroKortit = [];
    let jaksoData = JSON.parse(localStorage.getItem('sarmaysJakso')) || { tavoiteMin: 0, todellisetSek: 0 };

    // Estet√§√§n tuplak√§ytt√∂
    localStorage.setItem('sarmays_aktiivinen', Date.now());
    window.addEventListener('storage', (e) => {
        if (e.key === 'sarmays_aktiivinen') {
            alert("Ohjelma on jo auki toisessa v√§lilehdess√§!");
            document.body.innerHTML = "<h1>K√§yt√§ vain yht√§ v√§lilehte√§.</h1>";
        }
    });

    function aloitaVuoro() {
        console.log("Vuoro aloitettu"); // Honorin debuggausta varten
        new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play().catch(()=>{});
        
        aloitusAikaleima = Date.now();
        document.getElementById('aloita-nappi').style.display = "none";
        document.getElementById('tyo-alue').style.display = "block";
        
        kelloInterval = setInterval(paivitaNaytto, 1000); // Kello sekunneittain, joutuisuus kerran minuutissa paivitaNaytto-sis√§ll√§
        paivitaNaytto();
        tallennaLuonnos();
    }

    function tarkistaId(val) {
        if (val.length === 6) {
            document.getElementById('id-syotto').disabled = true;
            document.getElementById('laji-lisa-alue').style.display = "block";
            document.getElementById('laji-syotto').focus();
            new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play().catch(()=>{});
            tallennaLuonnos();
        }
    }

    // Enter-kuuntelija lajimerkille
    document.getElementById('laji-syotto').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            document.getElementById('skannaus-alue').style.display = "none";
            document.getElementById('vaihelomake').style.display = "block";
            new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play().catch(()=>{});
            tallennaLuonnos();
        }
    });

    function muunnaMin(val) {
        if (!val) return 0;
        let p = val.toString().replace(',', '.').split('.');
        let m = parseInt(p[0]) || 0;
        let s = parseInt(p[1]) || 0;
        return m + (s / 60);
    }

    function tallennaKortti() {
        const id = document.getElementById('id-syotto').value;
        const laji = document.getElementById('laji-syotto').value;
        const asetus = parseFloat(document.getElementById('asetusaika').value) || 0;
        const tavoite = asetus + muunnaMin(document.getElementById('taivutusaika').value) + muunnaMin(document.getElementById('muu-vaihe-aika').value);
        
        vuoroTavoiteMin += tavoite;
        vuoroKortit.push({ id, laji, tavoite });

        // Palautus skannaukseen
        document.getElementById('skannaus-alue').style.display = "block";
        document.getElementById('vaihelomake').style.display = "none";
        document.getElementById('id-syotto').disabled = false;
        document.getElementById('id-syotto').value = "";
        document.getElementById('laji-syotto').value = "";
        document.getElementById('laji-lisa-alue').style.display = "none";
        
        paivitaNaytto();
        tallennaLuonnos();
    }

    function paivitaNaytto() {
        if (!aloitusAikaleima) return;
        let kulunutSek = Math.floor((Date.now() - aloitusAikaleima) / 1000);
        document.getElementById('tyoaika-display').innerText = new Date(kulunutSek * 1000).toISOString().substr(11, 8);
        
        // Joutuisuus lasketaan vain jos kortteja on valmiina
        if (vuoroKortit.length > 0) {
            let vJout = (vuoroTavoiteMin / 60) / (kulunutSek / 3600);
            document.getElementById('vuoro-joutuisuus').innerText = vJout.toFixed(2);
            
            let jTunnitTotal = (jaksoData.todellisetSek + kulunutSek) / 3600;
            let jJout = ((jaksoData.tavoiteMin + vuoroTavoiteMin) / 60) / jTunnitTotal;
            document.getElementById('jakso-joutuisuus').innerText = jJout.toFixed(2);
        }
    }

    function tallennaLuonnos() {
        const tila = {
            id: document.getElementById('id-syotto').value,
            idLukittu: document.getElementById('id-syotto').disabled,
            laji: document.getElementById('laji-syotto').value,
            asetus: document.getElementById('asetusaika').value,
            taivutus: document.getElementById('taivutusaika').value,
            aloitus: aloitusAikaleima,
            lomakeAuki: document.getElementById('vaihelomake').style.display === 'block',
            kortit: vuoroKortit,
            tavoiteMin: vuoroTavoiteMin
        };
        localStorage.setItem('sarmaysLuonnos', JSON.stringify(tila));
    }

    function tarkistaTila() {
        const data = JSON.parse(localStorage.getItem('sarmaysLuonnos'));
        if (!data || !data.aloitus) return;

        aloitusAikaleima = data.aloitus;
        vuoroKortit = data.kortit || [];
        vuoroTavoiteMin = data.tavoiteMin || 0;
        
        document.getElementById('aloita-nappi').style.display = "none";
        document.getElementById('tyo-alue').style.display = "block";
        
        document.getElementById('id-syotto').value = data.id || "";
        if (data.idLukittu) {
            document.getElementById('id-syotto').disabled = true;
            document.getElementById('laji-lisa-alue').style.display = "block";
            document
