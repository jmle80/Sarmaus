<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Työvuoroseuranta</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        #version-display {
            color: #d32f2f;
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 10px;
            display: block;
        }

        h1, h2 { text-align: center; color: #2c3e50; }

        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .status-panel {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .clock {
            font-size: 2em;
            font-family: 'Courier New', Courier, monospace;
            margin: 10px 0;
            font-weight: bold;
        }

        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        
        input[type="text"], input[type="number"] {
            width: 100%; padding: 10px; border: 1px solid #ddd;
            border-radius: 4px; box-sizing: border-box; font-size: 16px;
        }

        .btn-group {
            display: flex; gap: 10px; flex-wrap: wrap;
            justify-content: center; margin-top: 20px;
        }

        button {
            padding: 12px 20px; border: none; border-radius: 4px;
            cursor: pointer; font-size: 16px; font-weight: bold;
            transition: background-color 0.3s;
        }

        .btn-start { background-color: #4CAF50; color: white; }
        .btn-end { background-color: #f44336; color: white; }
        .btn-scan { background-color: #2196F3; color: white; }
        .btn-reset { background-color: #ff9800; color: white; }
        .btn-backup { background-color: #607d8b; color: white; }

        /* --- SKANNERIN TYYLIT (PÄIVITETTY V3.4) --- */
        #reader {
            width: 100%; 
            margin: 20px auto; 
            display: none;
            background-color: #000; 
            position: relative;
            
            /* Rajoitetaan etsimen kokoa, ettei se ole koko ruudun kokoinen */
            max-width: 400px;
            max-height: 300px;
            overflow: hidden; /* Piilottaa ylimenevän videon reunoilta */
            border-radius: 8px;
        }

        /* Kameran vihreä raita ja reunat pois */
        #reader__scan_region { 
            border: none !important; 
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5) !important; /* Tummentaa alueen ympäriltä */
            background: transparent !important; 
        }
        #reader__dashboard_section_csr span { display: none !important; }

        /* HISTORIA */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; }

        @media screen and (max-width: 600px) {
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { border: 1px solid #ccc; margin-bottom: 10px; }
            td { border: none; border-bottom: 1px solid #eee; position: relative; padding-left: 50%; }
            td:before { position: absolute; top: 12px; left: 6px; width: 45%; padding-right: 10px; white-space: nowrap; font-weight: bold; content: attr(data-label); }
        }
    </style>
</head>
<body>

    <div id="version-display">Versio 3.4 (Kompakti vaakaskanneri)</div>

    <div class="container">
        <h1>Työvuoroseuranta</h1>

        <div class="status-panel">
            <div>Nykyinen tila: <span id="status-text" style="font-weight:bold; color:red;">Ei vuoroa</span></div>
            <div id="live-clock" class="clock">00:00:00</div>
            <div id="duration-timer" style="font-size: 1.2em; color: #555;">Kesto: 00:00:00</div>
        </div>

        <div class="input-group">
            <label for="card-number">Kortin numero (6 numeroa):</label>
            <input type="text" id="card-number" placeholder="123456" maxlength="6">
        </div>

        <div class="input-group">
            <label for="type-mark">Lajimerkki (Kirjaimet -> ISOIKSI):</label>
            <input type="text" id="type-mark" placeholder="ABC">
        </div>

        <div id="reader"></div>

        <div class="btn-group">
            <button class="btn-start" onclick="startShift()">Aloita vuoro</button>
            <button class="btn-end" onclick="endShift()">Lopeta vuoro</button>
            <button class="btn-scan" onclick="toggleScanner()">Skannaa viivakoodi</button>
        </div>
        
        <div class="btn-group">
             <button class="btn-backup" onclick="downloadBackup()">Lataa varmuuskopio</button>
             <input type="file" id="restore-file" style="display:none" onchange="restoreBackup(this)">
             <button class="btn-backup" onclick="document.getElementById('restore-file').click()">Palauta varmuuskopio</button>
             <button class="btn-reset" onclick="clearHistory()">Nollaa historia</button>
        </div>
    </div>

    <div class="container">
        <h2>Historia</h2>
        <table id="history-table">
            <thead>
                <tr>
                    <th>Pvm</th>
                    <th>Aloitus</th>
                    <th>Lopetus</th>
                    <th>Kesto</th>
                    <th>Kortti</th>
                    <th>Laji</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        let shiftStartTime = null;
        let shiftTimerInterval = null;
        let html5QrCode = null;
        let isScanning = false;
        
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBeep() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.type = 'sine';
            oscillator.frequency.value = 880; 
            gainNode.gain.value = 0.1;
            oscillator.start();
            setTimeout(() => { oscillator.stop(); }, 200);
        }

        window.onload = function() {
            updateLiveClock();
            setInterval(updateLiveClock, 1000);
            loadHistory();
            
            const savedStart = localStorage.getItem('currentShiftStart');
            if (savedStart) {
                shiftStartTime = new Date(savedStart);
                startTimerOnly();
                document.getElementById('status-text').textContent = "Vuoro käynnissä";
                document.getElementById('status-text').style.color = "green";
                document.getElementById('card-number').value = localStorage.getItem('currentCard') || '';
                document.getElementById('type-mark').value = localStorage.getItem('currentType') || '';
            }
            document.getElementById('card-number').addEventListener('input', validateCardNumber);
            document.getElementById('type-mark').addEventListener('input', forceUpperCase);
        };

        function updateLiveClock() {
            document.getElementById('live-clock').textContent = new Date().toLocaleTimeString('fi-FI');
        }

        function startTimerOnly() {
            if (shiftTimerInterval) clearInterval(shiftTimerInterval);
            shiftTimerInterval = setInterval(() => {
                if (!shiftStartTime) return;
                const diff = new Date() - shiftStartTime;
                const d = new Date(diff);
                document.getElementById('duration-timer').textContent = 
                    `Kesto: ${d.getUTCHours().toString().padStart(2,'0')}:${d.getUTCMinutes().toString().padStart(2,'0')}:${d.getUTCSeconds().toString().padStart(2,'0')}`;
            }, 1000);
        }

        function validateCardNumber(e) {
            let val = e.target.value.replace(/[^0-9]/g, '');
            if (val.length > 6) val = val.slice(0, 6);
            e.target.value = val;
            if (shiftStartTime) localStorage.setItem('currentCard', val);
        }

        function forceUpperCase(e) {
            let val = e.target.value.toUpperCase();
            e.target.value = val;
            if (shiftStartTime) localStorage.setItem('currentType', val);
        }

        function startShift() {
            if (shiftStartTime) { alert("Vuoro on jo käynnissä!"); return; }
            playBeep();
            shiftStartTime = new Date();
            localStorage.setItem('currentShiftStart', shiftStartTime);
            localStorage.setItem('currentCard', document.getElementById('card-number').value);
            localStorage.setItem('currentType', document.getElementById('type-mark').value);
            document.getElementById('status-text').textContent = "Vuoro käynnissä";
            document.getElementById('status-text').style.color = "green";
            startTimerOnly();
        }

        function endShift() {
            if (!shiftStartTime) { alert("Ei käynnissä olevaa vuoroa."); return; }
            const card = document.getElementById('card-number').value;
            if (card.length !== 6) { alert("Kortin numeron pitää olla tasan 6 numeroa!"); return; }
            
            playBeep(); // Ääni lopussa

            const end = new Date();
            const diff = end - shiftStartTime;
            const d = new Date(diff);
            const dur = `${d.getUTCHours().toString().padStart(2,'0')}:${d.getUTCMinutes().toString().padStart(2,'0')}:${d.getUTCSeconds().toString().padStart(2,'0')}`;

            const entry = {
                date: shiftStartTime.toLocaleDateString('fi-FI'),
                start: shiftStartTime.toLocaleTimeString('fi-FI'),
                end: end.toLocaleTimeString('fi-FI'),
                duration: dur,
                card: card,
                type: document.getElementById('type-mark').value
            };

            let history = JSON.parse(localStorage.getItem('shiftHistory') || "[]");
            history.push(entry);
            localStorage.setItem('shiftHistory', JSON.stringify(history));
            addHistoryRow(entry);

            shiftStartTime = null;
            clearInterval(shiftTimerInterval);
            document.getElementById('duration-timer').textContent = "Kesto: 00:00:00";
            document.getElementById('status-text').textContent = "Ei vuoroa";
            document.getElementById('status-text').style.color = "red";
            localStorage.removeItem('currentShiftStart');
            localStorage.removeItem('currentCard');
            localStorage.removeItem('currentType');
            document.getElementById('card-number').value = "";
            document.getElementById('type-mark').value = "";
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('shiftHistory') || "[]");
            const tbody = document.querySelector('#history-table tbody');
            tbody.innerHTML = "";
            history.slice().reverse().forEach(entry => addHistoryRow(entry));
        }

        function addHistoryRow(entry) {
            const tbody = document.querySelector('#history-table tbody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td data-label="Pvm">${entry.date}</td>
                <td data-label="Aloitus">${entry.start}</td>
                <td data-label="Lopetus">${entry.end}</td>
                <td data-label="Kesto">${entry.duration}</td>
                <td data-label="Kortti">${entry.card}</td>
                <td data-label="Laji">${entry.type}</td>
            `;
            if (tbody.firstChild) tbody.insertBefore(row, tbody.firstChild);
            else tbody.appendChild(row);
        }

        function clearHistory() {
            if (confirm("Haluatko varmasti nollata koko jakson historian? (Do you really want to reset the entire period history?)")) {
                localStorage.removeItem('shiftHistory');
                loadHistory();
            }
        }

        function downloadBackup() {
            const blob = new Blob([localStorage.getItem('shiftHistory') || "[]"], { type: "application/json" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "tyovuorot_" + new Date().toISOString().slice(0,10) + ".json";
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        function restoreBackup(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        if(confirm("Tämä korvaa nykyisen historian. Oletko varma?")) {
                            localStorage.setItem('shiftHistory', JSON.stringify(data));
                            loadHistory();
                            alert("Palautettu!");
                        }
                    } else alert("Virheellinen tiedosto.");
                } catch (err) { alert("Virhe: " + err.message); }
            };
            reader.readAsText(file);
        }

        function toggleScanner() {
            const readerElem = document.getElementById('reader');
            if (isScanning) {
                if (html5QrCode) html5QrCode.stop().then(() => {
                    readerElem.style.display = "none";
                    isScanning = false;
                    document.querySelector('.btn-scan').textContent = "Skannaa viivakoodi";
                });
            } else {
                readerElem.style.display = "block";
                if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
                
                // SKANNERIN ASETUKSET (Päivitetty V3.4)
                const config = { 
                    fps: 10, 
                    // Tärkeä: Matala ja leveä alue viivakoodeille (250px leveä, 80px korkea)
                    qrbox: { width: 250, height: 80 }, 
                    aspectRatio: 1.33 
                };
                
                html5QrCode.start({ facingMode: "environment" }, config,
                (decodedText) => {
                    playBeep();
                    document.getElementById('card-number').value = decodedText;
                    validateCardNumber({ target: document.getElementById('card-number') });
                    toggleScanner();
                }).catch(err => { alert("Kameravirhe: " + err); readerElem.style.display = "none"; });
            }
        }
    </script>
</body>
</html>
