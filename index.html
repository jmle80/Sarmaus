<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S√§rm√§ys Pro v3.8.9</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        .version-tag { color: #ff8c00; font-weight: bold; padding: 10px; font-size: 0.8rem; }
        body { font-family: sans-serif; text-align: center; padding: 10px; background: #f0f2f5; }
        #tyoaika-display { font-family: monospace; font-size: 2rem; margin: 10px 0; }
        
        /* Skanneri ja ID-kentt√§ */
        #reader { width: 300px !important; height: 180px !important; margin: 10px auto; border-radius: 12px; overflow: hidden; background: #000; }
        #reader video { object-fit: cover !important; width: 100% !important; height: 100% !important; }

        /* Lajivalikko */
        #lajivalikko { display: none; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 10px; }
        .laji-nappi { background: #007bff; color: white; padding: 15px; margin: 5px; border-radius: 8px; border: none; font-weight: bold; width: 40%; }
        
        /* Raportti */
        #raportti { display: none; background: #fff; border: 2px solid #007bff; border-radius: 12px; padding: 20px; text-align: left; }
        .raportti-rivi { margin: 5px 0; font-size: 0.9rem; border-bottom: 1px solid #eee; }
        
        button { width: 100%; padding: 20px; font-size: 1.2rem; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; }
        .btn-aloita { background: #28a745; color: white; }
        .btn-lopeta { background: #dc3545; color: white; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="version-tag">Versio 3.8.9 üü†</div>
    <div id="tyoaika-display">00:00:00</div>

    <div id="tyo-alue" style="display:none;">
        <div id="reader"></div>
        <input type="text" id="id-naytto" readonly placeholder="Skannaa kortti..." style="width:80%; padding:10px; margin:10px; font-size:1.2rem; text-align:center; border-radius:8px; border:1px solid #ccc;">
        
        <div id="lajivalikko">
            <p>Valitse lajimerkki:</p>
            <button class="laji-nappi" onclick="tallennaKortti('Laji A')">Laji A</button>
            <button class="laji-nappi" onclick="tallennaKortti('Laji B')">Laji B</button>
            <button class="laji-nappi" onclick="tallennaKortti('Laji C')">Laji C</button>
            <button class="laji-nappi" onclick="tallennaKortti('Muu')">Muu</button>
        </div>
        
        <button id="paa-nappi" class="btn-lopeta" onclick="lopetaVuoro()">LOPETA VUORO üèÅ</button>
    </div>

    <div id="raportti">
        <h3>Ty√∂vuoron yhteenveto üìã</h3>
        <div id="rep-ajat"></div>
        <h4>Tehdyt kortit:</h4>
        <div id="rep-kortit"></div>
        <hr>
        <h4>Lajikohtaiset m√§√§r√§t:</h4>
        <div id="rep-lajit"></div>
        <button class="btn-aloita" style="margin-top:20px;" onclick="location.reload()">SULJE üîÑ</button>
    </div>

    <button id="aloita-nappi" class="btn-aloita" onclick="aloitaVuoro()">ALOITA TY√ñVUORO üöÄ</button>

<script>
    let aloitusAikaleima = null;
    let kelloInterval = null;
    let html5QrCode = null;
    let tehdytKortit = []; // Lista johon tallennetaan {id, laji, aika}
    let viimeisinID = "";

    function aloitaVuoro() {
        let syote = prompt("Aloitusaika (HH:MM) tai tyhj√§:", "");
        if (syote === null) return;

        let nyt = new Date();
        if (syote.trim() !== "") {
            let osat = syote.split(/[:.]/);
            if (osat.length >= 2) nyt.setHours(parseInt(osat[0]), parseInt(osat[1]), 0, 0);
        }
        
        aloitusAikaleima = nyt.getTime();
        document.getElementById('aloita-nappi').style.display = "none";
        document.getElementById('tyo-alue').style.display = "block";
        kelloInterval = setInterval(paivitaKello, 1000);
        kaynnistaSkanneri();
    }

    function kaynnistaSkanneri() {
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 200 }, (txt) => {
            if (/^\d{6}$/.test(txt) && viimeisinID !== txt) {
                viimeisinID = txt;
                document.getElementById('id-naytto').value = "ID: " + txt;
                document.getElementById('lajivalikko').style.display = "block";
                new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play().catch(()=>{});
            }
        });
    }

    function tallennaKortti(laji) {
        let nyt = new Date();
        tehdytKortit.push({
            id: viimeisinID,
            laji: laji,
            kellonaika: nyt.getHours().toString().padStart(2,'0') + ":" + nyt.getMinutes().toString().padStart(2,'0')
        });
        
        // Nollataan valikko seuraavaa varten
        viimeisinID = "";
        document.getElementById('id-naytto').value = "";
        document.getElementById('lajivalikko').style.display = "none";
    }

    function lopetaVuoro() {
        if (!confirm("Haluatko varmasti lopettaa?")) return;
        
        let syote = prompt("Lopetusaika (HH:MM) tai tyhj√§:", "");
        let lopetusAika = new Date();
        if (syote && syote.trim() !== "") {
            let osat = syote.split(/[:.]/);
            if (osat.length >= 2) lopetusAika.setHours(parseInt(osat[0]), parseInt(osat[1]), 0, 0);
        }

        clearInterval(kelloInterval);
        if(html5QrCode) html5QrCode.stop();
        
        naytaRaportti(lopetusAika);
    }

    function naytaRaportti(lopetusAika) {
        document.getElementById('tyo-alue').style.display = "none";
        document.getElementById('tyoaika-display').style.display = "none";
        
        // Ajat
        let kestoMs = lopetusAika.getTime() - aloitusAikaleima;
        document.getElementById('rep-ajat').innerHTML = `
            <p>Aloitus: ${new Date(aloitusAikaleima).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
            <p>Lopetus: ${lopetusAika.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
            <p><b>Kesto: ${muotoileKesto(kestoMs)}</b></p>
        `;

        // Korttilista
        let korttiHtml = "";
        let lajiMaarat = {};
        
        tehdytKortit.forEach(k => {
            korttiHtml += `<div class="raportti-rivi">${k.kellonaika} - ID: ${k.id} (${k.laji})</div>`;
            lajiMaarat[k.laji] = (lajiMaarat[k.laji] || 0) + 1;
        });
        document.getElementById('rep-kortit').innerHTML = korttiHtml || "Ei kortteja.";

        // Lajitilasto
        let lajiHtml = "";
        for (let laji in lajiMaarat) {
            lajiHtml += `<p>${laji}: ${lajiMaarat[laji]} kpl</p>`;
        }
        document.getElementById('rep-lajit').innerHTML = lajiHtml || "-";

        document.getElementById('raportti').style.display = "block";
    }

    function muotoileKesto(ms) {
        let sek = Math.floor(ms / 1000);
        let h = Math.floor(sek / 3600).toString().padStart(2, '0');
        let m = Math.floor((sek % 3600) / 60).toString().padStart(2, '0');
        let s = (sek % 60).toString().padStart(2, '0');
        return `${h}:${m}:${s}`;
    }

    function paivitaKello() {
        let erotusMs = new Date().getTime() - aloitusAikaleima;
        document.getElementById('tyoaika-display').innerText = muotoileKesto(erotusMs);
    }
</script>
</body>
</html>
