<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S√§rm√§ys Pro v4.1.0</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 10px; background: #f4f4f9; color: #333; }
        
        /* Tyylit */
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header { text-align: center; font-size: 0.9rem; color: #666; margin-bottom: 10px; }
        .mittari-alue { display: flex; justify-content: space-between; margin-bottom: 20px; background: #eef2f5; padding: 10px; border-radius: 8px; }
        .mittari-box { text-align: center; width: 48%; }
        .mittari-arvo { font-size: 1.5rem; font-weight: bold; color: #007bff; font-family: monospace; }
        .kello { font-size: 2rem; text-align: center; font-family: monospace; margin: 10px 0; font-weight: bold; }
        
        /* Sy√∂tteet ja napit */
        input, button { width: 100%; padding: 15px; font-size: 1.2rem; border-radius: 8px; border: 2px solid #ddd; margin-bottom: 10px; box-sizing: border-box; }
        input:focus { border-color: #007bff; outline: none; }
        
        .btn-aloita { background: #28a745; color: white; border: none; font-weight: bold; }
        .btn-lopeta { background: #dc3545; color: white; border: none; margin-top: 10px; }
        .btn-tallenna { background: #007bff; color: white; border: none; font-weight: bold; }
        
        /* Skannerin tyylit - Pienennetty ja siistitty */
        #reader { width: 100%; border-radius: 8px; overflow: hidden; margin-bottom: 10px; border: none !important; }
        #reader video { object-fit: cover; border-radius: 8px; }
        
        /* Piilotettavat elementit */
        .hidden { display: none; }
        
        /* Raportti */
        #raportti-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; padding: 20px; overflow-y: auto; box-sizing: border-box; display: none; }
        .kortti-rivi { border-bottom: 1px solid #eee; padding: 10px 0; font-family: monospace; }
    </style>
</head>
<body onload="alustaOhjelma()">

<div class="container">
    <div class="header">S√§rm√§ys Pro v4.1.0 üü¢</div>

    <div class="mittari-alue">
        <div class="mittari-box"><div>Vuoro</div><div id="v-jout" class="mittari-arvo">0.00</div></div>
        <div class="mittari-box"><div>Jakso</div><div id="j-jout" class="mittari-arvo">0.00</div></div>
    </div>
    
    <div id="kello" class="kello">00:00:00</div>

    <div id="aloitus-paneeli">
        <label style="font-weight:bold; display:block; margin-bottom:5px;">Sy√∂t√§ aloitusaika (4 numeroa):</label>
        <input type="tel" id="aloitus-syotto" placeholder="esim. 0600" maxlength="4" oninput="kasitteleAloitusAika(this)">
        <div style="font-size: 0.8rem; color: #666; text-align: center;">Vuoro alkaa heti kun 4 numeroa on sy√∂tetty.</div>
    </div>

    <div id="tyo-alue" class="hidden">
        
        <div id="skannaus-osio">
            <div id="reader"></div>
            <input type="tel" id="id-input" placeholder="Skannaa tai sy√∂t√§ ID" oninput="tarkistaId(this.value)">
            <button onclick="avaaKamera()" style="background:#ffc107; color:#000;">Avaa Kamera üì∑</button>
        </div>

        <div id="vaiheet-osio" class="hidden">
            <input type="text" id="laji-input" placeholder="LAJIMERKKI (ISOT)" oninput="this.value = this.value.toUpperCase(); tallennaTila()" style="text-transform:uppercase;">
            
            <div style="display:flex; gap:5px;">
                <input type="number" id="a-aika" placeholder="Asetus (min)" oninput="tallennaTila()">
                <input type="number" id="t-aika" placeholder="Taivutus (min.sek)" step="0.01" oninput="tallennaTila()">
            </div>
            
            <input type="text" id="m-nimi" placeholder="Muu ty√∂ (nimi)" oninput="this.value = this.value.toUpperCase(); tallennaTila()">
            <input type="number" id="m-aika" placeholder="Muu aika (min.sek)" step="0.01" oninput="tallennaTila()">
            
            <button class="btn-tallenna" onclick="tallennaKortti()">TALLENNA ‚úÖ</button>
            <button onclick="peruutaKortti()" style="background:#6c757d; color:white; margin-top:5px;">Peruuta ‚Ü©Ô∏è</button>
        </div>

        <button class="btn-lopeta" onclick="lopetaVuoro()">LOPETA VUORO üèÅ</button>
        <button onclick="naytaRaportti()" style="margin-top:10px; background:#17a2b8; color:white;">Raportti üìä</button>
    </div>
</div>

<div id="raportti-modal">
    <h2>Yhteenveto</h2>
    <div id="raportti-lista"></div>
    <button onclick="suljeRaportti()" style="margin-top:20px;">Sulje</button>
    <button onclick="nollaaJakso()" style="background:red; color:white; margin-top:30px;">NOLLAA JAKSO ‚ö†Ô∏è</button>
</div>

<script>
    // --- Muuttujat ---
    let d = { aloitus: null, kortit: [], tavoite: 0 };
    let jakso = JSON.parse(localStorage.getItem('sarmaysJakso')) || { min: 0, sek: 0 };
    let html5QrCode;
    let ajastin;

    // --- √Ñ√§ni ---
    function piippaus() {
        const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
        audio.play().catch(e => console.log("√Ñ√§ni estetty", e));
    }

    // --- Aloituslogiikka ---
    function kasitteleAloitusAika(input) {
        let val = input.value.replace(/[^0-9]/g, ''); // Vain numeroita
        input.value = val;

        if (val.length === 4) {
            let h = parseInt(val.substring(0, 2));
            let m = parseInt(val.substring(2, 4));

            if (h >= 0 && h < 24 && m >= 0 && m < 60) {
                // Aika on validi -> Aloitetaan automaattisesti
                let nyt = new Date();
                let aloitusAika = new Date(nyt.getFullYear(), nyt.getMonth(), nyt.getDate(), h, m, 0);
                
                // Jos aloitusaika on tulevaisuudessa (esim. y√∂vuoro edellisen√§ p√§iv√§n√§), korjataan tarvittaessa
                // T√§ss√§ yksinkertainen versio: oletetaan kuluva p√§iv√§.
                
                aloitaVuoro(aloitusAika.getTime());
            } else {
                alert("Virheellinen aika. Tarkista tunnit ja minuutit.");
                input.value = "";
            }
        }
    }

    function aloitaVuoro(aikaleima) {
        d.aloitus = aikaleima || Date.now();
        piippaus();
        paivitaNakyma("tyo");
        kaynnistaAjastin();
        tallennaTila();
    }

    // --- P√§√§n√§kym√§ ja Ajastin ---
    function paivitaNakyma(tila) {
        document.getElementById('aloitus-paneeli').style.display = tila === "aloitus" ? "block" : "none";
        document.getElementById('tyo-alue').style.display = tila === "tyo" ? "block" : "none";
        
        if(tila === "tyo") {
            // Varmistetaan ett√§ ID-kentt√§ on valmiina
            setTimeout(() => document.getElementById('id-input').focus(), 500);
        }
    }

    function kaynnistaAjastin() {
        if (ajastin) clearInterval(ajastin);
        ajastin = setInterval(() => {
            let nyt = Date.now();
            let kulunutSek = Math.floor((nyt - d.aloitus) / 1000);
            
            // Kello n√§ytt√∂√∂n
            let kelloDate = new Date();
            document.getElementById('kello').innerText = kelloDate.toLocaleTimeString('fi-FI');

            // Laskurit
            let jaksoMin = jakso.min + d.tavoite;
            let jaksoSek = jakso.sek + kulunutSek;

            let vJout = d.tavoite > 0 ? ((d.tavoite / 60) / (kulunutSek / 3600)).toFixed(2) : "0.00";
            let jJout = jaksoMin > 0 ? ((jaksoMin / 60) / (jaksoSek / 3600)).toFixed(2) : "0.00";

            document.getElementById('v-jout').innerText = vJout;
            document.getElementById('j-jout').innerText = jJout;

        }, 1000);
    }

    // --- Skannaus ja Sy√∂tt√∂ ---
    function avaaKamera() {
        const config = { fps: 10, qrbox: { width: 250, height: 150 } }; // Pienennetty laatikko
        
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
            document.getElementById('id-input').value = decodedText;
            piippaus();
            html5QrCode.stop().then(() => {
                document.getElementById('reader').innerHTML = ""; // Tyhjennys
                tarkistaId(decodedText);
            });
        }).catch(err => {
            console.log("Kameravirhe", err);
            alert("Kameraa ei voitu avata. Tarkista luvat.");
        });
    }

    function tarkistaId(val) {
        if (val.length >= 4) { // Hyv√§ksyt√§√§n kun tarpeeksi merkkej√§
            document.getElementById('skannaus-osio').classList.add('hidden');
            document.getElementById('vaiheet-osio').classList.remove('hidden');
            document.getElementById('laji-input').focus();
            tallennaTila();
        }
    }

    // --- Tallennus ---
    function muunnaMinuuteiksi(val) {
        if (!val) return 0;
        let osat = val.toString().split('.');
        let min = parseInt(osat[0]) || 0;
        let sek = parseInt(osat[1]) || 0;
        // Jos k√§ytt√§j√§ sy√∂tt√§√§ esim 1.30 (1 min 30 sek) -> 1.5 min
        // Jos k√§ytt√§j√§ sy√∂tt√§√§ 1.50 -> 1.5 min (normaali desimaali)
        // T√§ss√§ oletetaan suora desimaali tai "min.sek" logiikka?
        // Pidet√§√§n yksinkertaisena: 1.30 tarkoittaa 1.30 minuuttia laskennassa
        return parseFloat(val) || 0;
    }

    function tallennaKortti() {
        let a = parseFloat(document.getElementById('a-aika').value) || 0;
        let t = parseFloat(document.getElementById('t-aika').value) || 0; // Oletetaan ett√§ k√§ytt√§j√§ sy√∂tt√§√§ desimaaleina
        let m = parseFloat(document.getElementById('m-aika').value) || 0;
        
        // Huom: Jos haluat min.sek muunnoksen (esim 1.30 = 1,5min), se pit√§√§ lis√§t√§ t√§h√§n.
        // Nyt laskee suoraan desimaaleina.

        let yht = a + t + m;
        
        if (yht === 0) { alert("Sy√∂t√§ v√§hint√§√§n yksi aika!"); return; }

        d.kortit.push({
            id: document.getElementById('id-input').value,
            laji: document.getElementById('laji-input').value,
            aika: yht
        });
        d.tavoite += yht;
        
        piippaus();
        nollaaLomake();
        tallennaTila();
    }

    function nollaaLomake() {
        ['id-input', 'laji-input', 'a-aika', 't-aika', 'm-nimi', 'm-aika'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('vaiheet-osio').classList.add('hidden');
        document.getElementById('skannaus-osio').classList.remove('hidden');
        document.getElementById('id-input').focus();
    }

    function peruutaKortti() {
        nollaaLomake();
    }

    // --- Muistin hallinta ---
    function tallennaTila() {
        localStorage.setItem('sarmaysLuonnos', JSON.stringify(d));
    }

    function alustaOhjelma() {
        let luonnos = JSON.parse(localStorage.getItem('sarmaysLuonnos'));
        if (luonnos && luonnos.aloitus) {
            d = luonnos;
            paivitaNakyma("tyo");
            kaynnistaAjastin();
        } else {
            paivitaNakyma("aloitus");
            document.getElementById('aloitus-syotto').focus();
        }
    }

    function lopetaVuoro() {
        if(!confirm("Lopetetaanko vuoro?")) return;
        
        // Lis√§t√§√§n nykyinen saldo kokonaisjaksoon
        let nyt = Date.now();
        let kulunutSek = Math.floor((nyt - d.aloitus) / 1000);
        
        jakso.min += d.tavoite;
        jakso.sek += kulunutSek;
        localStorage.setItem('sarmaysJakso', JSON.stringify(jakso));
        
        // Nollataan p√§iv√§
        localStorage.removeItem('sarmaysLuonnos');
        location.reload();
    }

    // --- Raportointi ---
    function naytaRaportti() {
        let html = d.kortit.map((k, i) => 
            `<div class="kortti-rivi">#${i+1} ID:${k.id} | ${k.laji} | ${k.aika.toFixed(2)} min</div>`
        ).join('');
        document.getElementById('raportti-lista').innerHTML = html || "Ei kortteja t√§n√§√§n.";
        document.getElementById('raportti-modal').style.display = "block";
    }

    function suljeRaportti() {
        document.getElementById('raportti-modal').style.display = "none";
    }

    function nollaaJakso() {
        if(confirm("Haluatko varmasti nollata koko jakson historian?")) {
            localStorage.clear();
            location.reload();
        }
    }
</script>

</body>
</html>
