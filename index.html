<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Työvuoroseuranta</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Versiunumero */
        #version-display {
            color: #d32f2f;
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 10px;
            display: block;
        }

        h1, h2 {
            text-align: center;
            color: #2c3e50;
        }

        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .status-panel {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .clock {
            font-size: 2em;
            font-family: 'Courier New', Courier, monospace;
            margin: 10px 0;
            font-weight: bold;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }

        /* Napit */
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            font-weight: bold;
        }

        .btn-start { background-color: #4CAF50; color: white; }
        .btn-start:hover { background-color: #45a049; }

        .btn-end { background-color: #f44336; color: white; }
        .btn-end:hover { background-color: #d32f2f; }

        .btn-scan { background-color: #2196F3; color: white; }
        .btn-scan:hover { background-color: #1976D2; }

        .btn-reset { background-color: #ff9800; color: white; }
        .btn-reset:hover { background-color: #f57c00; }

        .btn-backup { background-color: #607d8b; color: white; }
        .btn-backup:hover { background-color: #455a64; }

        /* Skanneri */
        #reader {
            width: 100%;
            margin-top: 20px;
            display: none;
            background-color: black;
            position: relative;
        }

        #reader__scan_region {
            border: none !important; 
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.4) !important; 
            background: transparent !important;
        }
        #reader__dashboard_section_csr span {
            display: none !important;
        }

        /* Historia - Taulukko */
        /* Mahdollistetaan taulukon rullaus jos lista on pitkä */
        .history-wrapper {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        /* Kiinnitetty yläreuna (Sticky Header) */
        th {
            background-color: #e9ecef;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid #ccc;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        /* Mobiilioptimointi taulukolle */
        @media screen and (max-width: 600px) {
            table, thead, tbody, th, td, tr {
                display: block;
            }
            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            tr {
                border: 1px solid #ccc;
                margin-bottom: 10px;
            }
            td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 50%;
            }
            td:before {
                position: absolute;
                top: 12px;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                font-weight: bold;
                content: attr(data-label);
            }
            /* Mobiilissa poistetaan sticky header koska taulukko hajoaa blockeiksi */
            th { position: static; }
            .history-wrapper { max-height: none; border: none; }
        }
    </style>
</head>
<body>

    <div id="version-display">Versio 3.3 (Uudet sarakkeet)</div>

    <div class="container">
        <h1>Työvuoroseuranta</h1>

        <div class="status-panel">
            <div>Nykyinen tila: <span id="status-text" style="font-weight:bold; color:red;">Ei vuoroa</span></div>
            <div id="live-clock" class="clock">00:00:00</div>
            <div id="duration-timer" style="font-size: 1.2em; color: #555;">Kesto: 00:00:00</div>
        </div>

        <div class="input-group">
            <label for="card-number">Kortin numero (6 numeroa):</label>
            <input type="text" id="card-number" placeholder="123456" maxlength="6">
        </div>

        <div class="input-group">
            <label for="type-mark">Lajimerkki (Kirjaimet -> ISOIKSI):</label>
            <input type="text" id="type-mark" placeholder="ABC">
        </div>

        <div id="reader"></div>

        <div class="btn-group">
            <button class="btn-start" onclick="startShift()">Aloita vuoro</button>
            <button class="btn-end" onclick="endShift()">Lopeta vuoro</button>
            <button class="btn-scan" onclick="toggleScanner()">Skannaa viivakoodi</button>
        </div>
        
        <div class="btn-group">
             <button class="btn-backup" onclick="downloadBackup()">Lataa varmuuskopio (JSON)</button>
             <input type="file" id="restore-file" style="display:none" onchange="restoreBackup(this)">
             <button class="btn-backup" onclick="document.getElementById('restore-file').click()">Palauta varmuuskopio</button>
             <button class="btn-reset" onclick="clearHistory()">Nollaa historia</button>
        </div>
    </div>

    <div class="container">
        <h2>Historia</h2>
        <div class="history-wrapper">
            <table id="history-table">
                <thead>
                    <tr>
                        <th style="width: 15%;">Pvm</th>
                        <th style="width: 20%;">Kortti</th>
                        <th style="width: 15%;">Laji</th>
                        <th style="width: 50%;">Aika (Aloitus - Lopetus | Kesto)</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- MUUTTUJAT ---
        let shiftStartTime = null;
        let shiftTimerInterval = null;
        let html5QrCode = null;
        let isScanning = false;
        
        // Ääniefekti (Web Audio API)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBeep() {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            oscillator.type = 'sine';
            oscillator.frequency.value = 880; 
            gainNode.gain.value = 0.1; 
            
            oscillator.start();
            setTimeout(() => { oscillator.stop(); }, 200); 
        }

        // --- ALUSTUS ---
        window.onload = function() {
            updateLiveClock();
            setInterval(updateLiveClock, 1000);
            loadHistory();
            
            const savedStart = localStorage.getItem('currentShiftStart');
            if (savedStart) {
                shiftStartTime = new Date(savedStart);
                startTimerOnly();
                document.getElementById('status-text').textContent = "Vuoro käynnissä";
                document.getElementById('status-text').style.color = "green";
                
                document.getElementById('card-number').value = localStorage.getItem('currentCard') || '';
                document.getElementById('type-mark').value = localStorage.getItem('currentType') || '';
            }

            document.getElementById('card-number').addEventListener('input', validateCardNumber);
            document.getElementById('type-mark').addEventListener('input', forceUpperCase);
        };

        // --- KELLO JA AJASTIN ---
        function updateLiveClock() {
            const now = new Date();
            document.getElementById('live-clock').textContent = now.toLocaleTimeString('fi-FI');
        }

        function startTimerOnly() {
            if (shiftTimerInterval) clearInterval(shiftTimerInterval);
            shiftTimerInterval = setInterval(() => {
                if (!shiftStartTime) return;
                const now = new Date();
                const diff = now - shiftStartTime;
                const diffDate = new Date(diff);
                const hours = diffDate.getUTCHours().toString().padStart(2, '0');
                const minutes = diffDate.getUTCMinutes().toString().padStart(2, '0');
                const seconds = diffDate.getUTCSeconds().toString().padStart(2, '0');
                document.getElementById('duration-timer').textContent = `Kesto: ${hours}:${minutes}:${seconds}`;
            }, 1000);
        }

        // --- VALIDIOINTI ---
        function validateCardNumber(e) {
            let value = e.target.value.replace(/[^0-9]/g, '');
            if (value.length > 6) value = value.slice(0, 6);
            e.target.value = value;
            if (shiftStartTime) localStorage.setItem('currentCard', value);
        }

        function forceUpperCase(e) {
            let value = e.target.value.toUpperCase();
            e.target.value = value;
            if (shiftStartTime) localStorage.setItem('currentType', value);
        }

        // --- VUORON HALLINTA ---
        function startShift() {
            if (shiftStartTime) {
                alert("Vuoro on jo käynnissä!");
                return;
            }

            playBeep(); // Checklist: Ääni alussa

            shiftStartTime = new Date();
            localStorage.setItem('currentShiftStart', shiftStartTime);
            
            localStorage.setItem('currentCard', document.getElementById('card-number').value);
            localStorage.setItem('currentType', document.getElementById('type-mark').value);

            document.getElementById('status-text').textContent = "Vuoro käynnissä";
            document.getElementById('status-text').style.color = "green";
            startTimerOnly();
        }

        function endShift() {
            if (!shiftStartTime) {
                alert("Ei käynnissä olevaa vuoroa.");
                return;
            }

            const cardNumber = document.getElementById('card-number').value;
            // Checklist: 6-numeron tarkistus
            if (cardNumber.length !== 6) {
                alert("Kortin numeron pitää olla tasan 6 numeroa ennen lopetusta!");
                return;
            }

            playBeep(); // Checklist: Ääni lopussa

            const endTime = new Date();
            const durationMs = endTime - shiftStartTime;
            
            const diffDate = new Date(durationMs);
            const durationStr = `${diffDate.getUTCHours().toString().padStart(2, '0')}:${diffDate.getUTCMinutes().toString().padStart(2, '0')}:${diffDate.getUTCSeconds().toString().padStart(2, '0')}`;

            const entry = {
                date: shiftStartTime.toLocaleDateString('fi-FI'),
                start: shiftStartTime.toLocaleTimeString('fi-FI'),
                end: endTime.toLocaleTimeString('fi-FI'),
                duration: durationStr,
                card: cardNumber,
                type: document.getElementById('type-mark').value
            };

            saveToHistory(entry);
            
            shiftStartTime = null;
            clearInterval(shiftTimerInterval);
            document.getElementById('duration-timer').textContent = "Kesto: 00:00:00";
            document.getElementById('status-text').textContent = "Ei vuoroa";
            document.getElementById('status-text').style.color = "red";
            
            localStorage.removeItem('currentShiftStart');
            localStorage.removeItem('currentCard');
            localStorage.removeItem('currentType');
            
            document.getElementById('card-number').value = "";
            document.getElementById('type-mark').value = "";
        }

        // --- HISTORIA ---
        function saveToHistory(entry) {
            let history
