<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sarmauslaskuri</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f0f0f0; }
        .version { color: #d32f2f; font-weight: bold; font-size: 1.2em; display: block; margin-bottom: 10px; }
        .container { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto; }
        button { padding: 12px 20px; margin: 5px; cursor: pointer; font-size: 1em; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        button:hover { background-color: #e0e0e0; }
        .control-panel { margin-top: 20px; border-top: 2px solid #eee; padding-top: 10px; }
        .log { margin-top: 20px; white-space: pre-line; background: #fafafa; padding: 10px; border: 1px solid #ddd; max-height: 300px; overflow-y: auto; }
        
        .timer-display {
            font-size: 2.5em;
            font-weight: bold;
            color: #2e7d32;
            text-align: center;
            margin: 15px 0;
            font-family: monospace;
        }

        /* Uudet tietokent√§t */
        .info-box {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-weight: bold;
            text-align: center;
        }

        /* Kameran tyylit */
        #reader {
            width: 100%;
            display: none; /* Piilotettu oletuksena */
            margin-bottom: 15px;
        }
        
        /* Estoviesti */
        #blocked-message {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); color: white;
            z-index: 9999; text-align: center; padding-top: 20%; font-size: 1.5em;
        }
    </style>
</head>
<body>

    <div id="blocked-message">
        ‚ö†Ô∏è Ohjelma on jo auki toisessa v√§lilehdess√§ tai laitteessa.<br><br>
        Sulje t√§m√§ ikkuna.
    </div>

    <span class="version">Versio 1.09</span>

    <div class="container">
        <h1>Sarmauslaskuri</h1>
        
        <div id="tyoAika" class="timer-display">00:00</div>
        <div id="status">Ladataan...</div>

        <div id="korttiIkkuna" class="info-box">Kortin nro: -</div>
        <div id="lajiIkkuna" class="info-box">Lajimerkki: -</div>

        <div id="reader"></div>

        <div class="control-panel">
            <h3>Toiminnot</h3>
            <button id="vuoroNappi" onclick="hallitseVuoroa()">Aloita vuoro</button>
            <hr>
            <button onclick="avaaSkanneri()">üì∑ Skannaa viivakoodi</button>
            <button onclick="kirjaaTapahtuma('Manuaalinen kirjaus')">Kirjaa manuaalisesti</button>
            <hr>
            <button onclick="nollaaJakso()" style="color: red;">Nollaa jakson historia</button>
        </div>

        <div class="log" id="logArea"></div>
    </div>

    <script>
        // --- MUUTTUJAT ---
        let vuoroKaynnissa = false;
        let vuoronAloitusAika = null;
        let ajastinIntervalli = null;
        let html5QrCode = null; // Skannerin olio

        // --- KAKSOISK√ÑYNNISTYKSEN ESTO ---
        const bc = new BroadcastChannel('sarmaus_channel');
        bc.onmessage = (event) => {
            if (event.data === 'olen_taalla') {
                document.getElementById('blocked-message').style.display = 'block';
            } else if (event.data === 'kuka_on_siella') {
                bc.postMessage('olen_taalla');
            }
        };
        bc.postMessage('kuka_on_siella');


        // --- ALUSTUS & TALLENNUS ---
        window.onload = function() {
            lataaTiedot();
        };

        function tallennaTiedot() {
            const data = {
                vuoroKaynnissa: vuoroKaynnissa,
                vuoronAloitusAika: vuoronAloitusAika ? vuoronAloitusAika.getTime() : null,
                loki: document.getElementById('logArea').innerText,
                korttiData: document.getElementById('korttiIkkuna').innerText,
                lajiData: document.getElementById('lajiIkkuna').innerText
            };
            localStorage.setItem('sarmausData', JSON.stringify(data));
        }

        function lataaTiedot() {
            const dataJSON = localStorage.getItem('sarmausData');
            if (dataJSON) {
                const data = JSON.parse(dataJSON);
                
                document.getElementById('logArea').innerText = data.loki || "";
                
                // Palautetaan uudet kent√§t
                if (data.korttiData) document.getElementById('korttiIkkuna').innerText = data.korttiData;
                if (data.lajiData) document.getElementById('lajiIkkuna').innerText = data.lajiData;

                if (data.vuoroKaynnissa && data.vuoronAloitusAika) {
                    vuoroKaynnissa = true;
                    vuoronAloitusAika = new Date(data.vuoronAloitusAika);
                    document.getElementById("vuoroNappi").innerText = "Lopeta vuoro";
                    document.getElementById("status").innerText = "Vuoro palautettu muistista";
                    kaynnistaLaskuri();
                } else {
                    document.getElementById("status").innerText = "Vuoro ei k√§ynniss√§";
                }
            } else {
                document.getElementById("status").innerText = "Tervetuloa";
            }
        }

        // --- TOIMINNOT ---

        function soitaAani() {
            const context = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = context.createOscillator();
            const gainNode = context.createGain();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(440, context.currentTime); 
            oscillator.connect(gainNode);
            gainNode.connect(context.destination);
            oscillator.start();
            gainNode.gain.exponentialRampToValueAtTime(0.00001, context.currentTime + 0.5);
            oscillator.stop(context.currentTime + 0.5);
        }

        function hallitseVuoroa() {
            if (!vuoroKaynnissa) {
                // ALOITUS
                soitaAani();
                let syote = prompt("Sy√∂t√§ aloitusaika (esim. 0700) tai paina OK nykyhetkelle.");
                vuoronAloitusAika = kasitteleAikaSyote(syote);
                vuoroKaynnissa = true;
                
                document.getElementById("vuoroNappi").innerText = "Lopeta vuoro";
                document.getElementById("status").innerText = "Vuoro k√§ynniss√§";
                kirjaaLoki("Vuoro aloitettu: " + formatTime(vuoronAloitusAika));
                kaynnistaLaskuri();
                tallennaTiedot(); 

            } else {
                // LOPETUS
                pysaytaLaskuri();
                let syote = prompt("Sy√∂t√§ lopetusaika (esim. 1530) tai paina OK nykyhetkelle.");
                let lopetusaika = kasitteleAikaSyote(syote);

                vuoroKaynnissa = false;
                document.getElementById("vuoroNappi").innerText = "Aloita vuoro";
                document.getElementById("status").innerText = "Vuoro p√§√§ttynyt";
                
                kirjaaLoki("Vuoro lopetettu: " + formatTime(lopetusaika));
                
                vuoronAloitusAika = null;
                tallennaTiedot();
            }
        }

        // --- KAMERASKANNERI JA LOGIIKKA ---

        function avaaSkanneri() {
            const readerDiv = document.getElementById("reader");
            
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    html5QrCode = null;
                    readerDiv.style.display = "none";
                }).catch(err => console.log(err));
                return;
            }

            readerDiv.style.display = "block";
            html5QrCode = new Html5Qrcode("reader");
            
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => {
                alert("Kameran k√§ynnistys ep√§onnistui. Varmista, ett√§ annoit luvan.");
            });
        }

        function onScanSuccess(decodedText, decodedResult) {
            soitaAani();
            
            // --- T√ÑSS√Ñ ON UUSI LOGIIKKA ---
            if (decodedText.length === 6) {
                // Tasan 6 merkki√§ -> Kortin numero
                document.getElementById("korttiIkkuna").innerText = "Kortin nro: " + decodedText;
                kirjaaLoki("Luettu ty√∂kortti: " + decodedText);
            } else {
                // Muu pituus -> Lajimerkki
                document.getElementById("lajiIkkuna").innerText = "Lajimerkki: " + decodedText;
                kirjaaLoki("Luettu lajimerkki: " + decodedText);
            }

            // Tallennetaan heti, jotta tiedot pysyv√§t tallessa
            tallennaTiedot();

            // Suljetaan kamera
            html5QrCode.stop().then(() => {
                html5QrCode.clear();
                html5QrCode = null;
                document.getElementById("reader").style.display = "none";
            });
        }

        // --- APUFUNKTIOT ---

        function kasitteleAikaSyote(syote) {
            let nyt = new Date();
            if (!syote || syote.trim() === "") return nyt;
            let puhdas = syote.replace(/[^0-9]/g, ''); 
            if (puhdas.length === 4) {
                let t = parseInt(puhdas.substring(0, 2));
                let m = parseInt(puhdas.substring(2, 4));
                let uusi = new Date();
                uusi.setHours(t, m, 0, 0);
                return uusi;
            }
            return nyt;
        }

        function kaynnistaLaskuri() {
            paivitaKellonaika();
            ajastinIntervalli = setInterval(() => {
                paivitaKellonaika();
                tallennaTiedot(); 
            }, 1000);
        }

        function pysaytaLaskuri() {
            if (ajastinIntervalli) {
                clearInterval(ajastinIntervalli);
                ajastinIntervalli = null;
            }
        }

        function paivitaKellonaika() {
            if (!vuoronAloitusAika) return;
            let nyt = new Date();
            let erotus = nyt - vuoronAloitusAika; 
            let tunnit = Math.floor(erotus / (1000 * 60 * 60));
            let minuutit = Math.floor((erotus % (1000 * 60 * 60)) / (1000 * 60));
            
            let hStr = tunnit < 10 ? "0" + tunnit : tunnit;
            let mStr = minuutit < 10 ? "0" + minuutit : minuutit;

            document.getElementById("tyoAika").innerText = `${hStr}:${mStr}`;
        }

        function formatTime(dateObj) {
            let h = dateObj.getHours();
            let m = dateObj.getMinutes();
            return (h < 10 ? "0"+h : h) + ":" + (m < 10 ?
