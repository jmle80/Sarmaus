<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S√§rm√§ys Pro v4.0.3</title>
    <style>
        .version-tag { color: #ff8c00; font-weight: bold; padding: 10px; font-size: 0.8rem; text-align: center; }
        body { font-family: sans-serif; padding: 10px; background: #f0f2f5; margin: 0; color: #333; }
        .mittari-alue { display: flex; justify-content: space-around; background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .mittari-arvo { font-family: monospace; font-size: 1.4rem; font-weight: bold; color: #007bff; }
        input, button { width: 100%; padding: 15px; font-size: 1.1rem; border-radius: 12px; border: 2px solid #ddd; margin-bottom: 8px; box-sizing: border-box; }
        .btn-aloita { background: #28a745; color: white; border: none; font-size: 1.4rem; }
        .btn-tallenna { background: #007bff; color: white; border: none; }
        .btn-lopeta { background: #dc3545; color: white; border: none; margin-top: 20px; }
        #raportti-alue { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; overflow-y: auto; padding: 20px; }
    </style>
</head>
<body onload="tarkistaTila()">
    <div class="version-tag">Versio 4.0.3 üü†</div>

    <div class="mittari-alue">
        <div><div>Vuoro</div><div id="v-jout" class="mittari-arvo">0.00</div></div>
        <div><div>Jakso</div><div id="j-jout" class="mittari-arvo">0.00</div></div>
    </div>

    <div id="kello" style="font-size: 2.2rem; text-align: center; font-family: monospace; margin: 15px 0;">00:00:00</div>

    <div id="aloitus-paneeli">
        <label>Aseta vuoron aloitusaika:</label>
        <input type="time" id="aloitus-kello">
        <button class="btn-aloita" onclick="aloitaVuoro()">ALOITA TY√ñVUORO üöÄ</button>
    </div>

    <div id="tyo-alue" style="display:none;">
        <button style="background:#6c757d; color:white; border:none;" onclick="naytaRaportti()">RAPORTTI üìä</button>
        
        <div id="skannaus-osio">
            <input type="text" id="id-input" placeholder="Skannaa tai sy√∂t√§ ID" inputmode="numeric" 
                   oninput="this.value = this.value.replace(/[^0-9]/g, ''); if(this.value.length >= 6) tarkistaId(this.value)">
            
            <input type="text" id="laji-input" placeholder="LAJIMERKKI (ISOT)" style="display:none; text-transform: uppercase;" 
                   oninput="this.value = this.value.toUpperCase(); tallennaLuonnos()" onkeypress="lajiEnter(event)">
        </div>

        <div id="vaiheet" style="display:none; background: white; padding: 15px; border-radius: 12px; margin-top:10px;">
            <label>Ty√∂vaiheen tiedot:</label>
            <input type="number" id="a-aika" placeholder="Asetusaika (min)" oninput="tallennaLuonnos()">
            <input type="number" step="0.01" id="t-aika" placeholder="Taivutusaika (min.sek)" oninput="tallennaLuonnos()">
            <hr>
            <input type="text" id="m-nimi" placeholder="MUUN VAIHEEN NIMI" oninput="this.value = this.value.toUpperCase(); tallennaLuonnos()">
            <input type="number" step="0.01" id="m-aika" placeholder="Muu aika (min.sek)" oninput="tallennaLuonnos()">
            <button class="btn-tallenna" onclick="tallennaKortti()">TALLENNA KORTTI ‚úÖ</button>
        </div>

        <button class="btn-lopeta" onclick="lopetaVuoro()">LOPETA VUORO üèÅ</button>
    </div>

    <div id="raportti-alue">
        <h2>P√§iv√§n yhteenveto</h2>
        <div id="raportti-sisalto"></div>
        <button onclick="suljeRaportti()">SULJE</button>
        <button style="background:#ffc107; margin-top:30px;" onclick="nollaaKaikki()">NOLLAA KOKO JAKSO ‚ö†Ô∏è</button>
    </div>

<script>
    let d = { aloitus: null, kortit: [], tavoite: 0 };
    let jakso = JSON.parse(localStorage.getItem('sarmaysJakso')) || { min: 0, sek: 0 };

    function soita() { new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play().catch(()=>{}); }

    function aloitaVuoro() {
        let kelloVal = document.getElementById('aloitus-kello').value;
        if(!kelloVal) { alert("Aseta aloitusaika!"); return; }
        soita();
        d.aloitus = Date.now();
        
        // Vaihdetaan n√§kym√§
        document.getElementById('aloitus-paneeli').style.display = "none";
        document.getElementById('tyo-alue').style.display = "block";
        
        // Aktivoidaan etsin heti
        const idInput = document.getElementById('id-input');
        idInput.focus();
        
        setInterval(paivita, 1000);
        tallennaLuonnos();
    }

    function tarkistaId(v) {
        if(v.length >= 6) {
            soita();
            document.getElementById('id-input').disabled = true;
            document.getElementById('laji-input').style.display = "block";
            document.getElementById('laji-input').focus();
            tallennaLuonnos();
        }
    }

    function lajiEnter(e) {
        if(e.key === 'Enter') {
            soita();
            document.getElementById('skannaus-osio').style.display = "none";
            document.getElementById('vaiheet').style.display = "block";
            tallennaLuonnos();
        }
    }

    function muunna(v) {
        let s = v.toString().split('.');
        return (parseInt(s[0])||0) + ((parseInt(s[1])||0)/60);
    }

    function tallennaKortti() {
        let t = parseFloat(document.getElementById('a-aika').value||0) + muunna(document.getElementById('t-aika').value) + muunna(document.getElementById('m-aika').value);
        d.kortit.push({id: document.getElementById('id-input').value, laji: document.getElementById('laji-input').value, t: t});
        d.tavoite += t;
        
        // Palautetaan haku-tilaan
        document.getElementById('id-input').value = "";
        document.getElementById('id-input').disabled = false;
        document.getElementById('laji-input').value = "";
        document.getElementById('laji-input').style.display = "none";
        document.getElementById('vaiheet').style.display = "none";
        document.getElementById('skannaus-osio').style.display = "block";
        
        ["a-aika", "t-aika", "m-nimi", "m-aika"].forEach(id => document.getElementById(id).value = "");
        
        // Focus takaisin etsimeen automaattisesti
        document.getElementById('id-input').focus();
        
        soita();
        tallennaLuonnos();
    }

    function paivita() {
        if(!d.aloitus) return;
        let s = Math.floor((Date.now() - d.aloitus)/1000);
        document.getElementById('kello').innerText = new Date(s*1000).toISOString().substr(11,8);
        
        let jMin = jakso.min + d.tavoite;
        let jSek = jakso.sek + s;
        
        document.getElementById('v-jout').innerText = d.tavoite > 0 ? ((d.tavoite/60)/(s/3600)).toFixed(2) : "0.00";
        document.getElementById('j-jout').innerText = jMin > 0 ? ((jMin/60)/(jSek/3600)).toFixed(2) : "0.00";
    }

    function tallennaLuonnos() { localStorage.setItem('sarmaysLuonnos', JSON.stringify(d)); }

    function tarkistaTila() {
        let l = JSON.parse(localStorage.getItem('sarmaysLuonnos'));
        if(l && l.aloitus) {
            d = l;
            document.getElementById('aloitus-paneeli').style.display = "none";
            document.getElementById('tyo-alue').style.display = "block";
            setInterval(paivita, 1000);
            
            // Jos ollaan ID-vaiheessa, kohdistetaan etsimeen
            if(!d.id || d.id === "") {
                document.getElementById('id-input').focus();
            }
        }
    }

    function lopetaVuoro() {
        if(confirm("Lopetetaanko vuoro? Jakson historia s√§ilyy.")) {
            jakso.min += d.tavoite;
            jakso.sek += Math.floor((Date.now() - d.aloitus)/1000);
            localStorage.setItem('sarmaysJakso', JSON.stringify(jakso));
            localStorage.removeItem('sarmaysLuonnos');
            location.reload();
        }
    }

    function nollaaKaikki() {
        if(confirm("Haluatko varmasti nollata koko jakson historian?")) {
            localStorage.clear();
            location.reload();
        }
    }

    function naytaRaportti() {
        let html = d.kortit.map(k => `<p>${k.id} | ${k.laji} | ${k.t.toFixed(2)} min</p>`).join('');
        document.getElementById('raportti-sisalto').innerHTML = html || "Ei kortteja.";
        document.getElementById('raportti-alue').style.display = "block";
    }
    function suljeRaportti() { document.getElementById('raportti-alue').style.display = "none"; }
</script>
</body>
</html>
