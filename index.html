<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SärmäysPro - VAMM Steel</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { 
            --vamm-yellow: #fecb00; 
            --bg: #000000;
            --card: #1a1a1a;
            --text: #ffffff;
        }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        
        .version-header { color: var(--vamm-yellow); font-weight: 900; font-size: 0.8rem; text-align: center; margin-bottom: 5px; }
        
        .logo-area { text-align: center; padding: 10px 0; border-bottom: 3px solid var(--vamm-yellow); margin-bottom: 20px; }
        .logo-main { font-weight: 900; font-size: 1.8rem; letter-spacing: 2px; }
        .logo-sub { font-weight: 300; font-size: 1.8rem; }

        .card { background: var(--card); padding: 20px; border-radius: 15px; margin-bottom: 15px; text-align: center; }
        .timer-val { font-size: 5rem; font-family: monospace; color: var(--vamm-yellow); font-weight: 900; margin: 10px 0; display: block; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .stat-box { background: #000; padding: 10px; border-radius: 10px; border: 1px solid #333; }
        .stat-val { font-size: 1.2rem; font-weight: 900; display: block; }
        .stat-label { font-size: 0.6rem; color: #888; text-transform: uppercase; }

        .btn-main { border: none; border-radius: 12px; font-weight: 900; font-size: 1.3rem; height: 75px; width: 100%; cursor: pointer; text-transform: uppercase; }
        .btn-start { background: var(--vamm-yellow); color: #000; }
        .btn-stop { background: #ce1126; color: #fff; }
        .btn-gray { background: #333d47; color: #fff; }

        input { width: 100%; padding: 15px; background: #000; border: 1px solid #444; border-radius: 10px; color: #fff; font-size: 1.2rem; margin-bottom: 8px; text-align: center; }
        .history-row { display: flex; padding: 15px; background: #111; margin-top: 5px; border-radius: 8px; font-size: 0.9rem; justify-content: space-between; }
    </style>
</head>
<body>

<div class="container">
    <div class="version-header">VERSION v5.2.5</div>
    
    <div class="logo-area">
        <span class="logo-main" style="color:var(--vamm-yellow)">VAMM</span>
        <span class="logo-sub">STEEL</span>
    </div>

    <div class="card">
        <div id="clockDisplay" class="timer-val">00:00:00</div>
        <div class="grid">
            <div class="stat-box"><span id="effVal" class="stat-val">0.00</span><span class="stat-label">EFF</span></div>
            <div class="stat-box"><span id="minVal" class="stat-val">0</span><span class="stat-label">MIN</span></div>
            <div class="stat-box" onclick="openArchive()"><span id="archEff" class="stat-val" style="color:var(--vamm-yellow)">0.00</span><span class="stat-label">JAKSO</span></div>
        </div>
    </div>

    <div style="margin-bottom: 15px;">
        <button id="mainBtn" class="btn-main btn-start" onclick="toggleShift()">ALOITA VUORO</button>
    </div>

    <div id="inputArea" style="display:none">
        <div class="grid">
            <button class="btn-main btn-gray" style="height:50px; font-size:0.8rem" onclick="addManual('FAIL')">HÄIRIÖ</button>
            <button class="btn-main btn-gray" style="height:50px; font-size:0.8rem; background:#6b21a8" onclick="addManual('PROTO')">PROTO</button>
            <button class="btn-main btn-gray" style="height:50px; font-size:0.8rem" onclick="triggerScan()">SKANNAA</button>
        </div>
        <input type="text" id="in_id" placeholder="TYÖNUMERO">
        <input type="text" id="in_laji" placeholder="LAJIMERKKI">
        <div class="grid">
            <input type="number" id="in_s" placeholder="ASET" oninput="checkAuto()">
            <input type="number" id="in_t" placeholder="TAIV" oninput="checkAuto()">
            <input type="number" id="in_m" placeholder="MUUT" oninput="checkAuto()">
        </div>
    </div>

    <div id="logList"></div>
</div>

<div id="archiveModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:1000; display:none; padding:20px; overflow-y:auto;">
    <button onclick="closeArchive()" style="float:right; color:white; background:none; border:none; font-size:2rem">✕</button>
    <h2 style="color:var(--vamm-yellow)">ARKISTO</h2>
    <div id="archiveContent"></div>
    <button onclick="resetAll()" class="btn-main btn-stop" style="margin-top:20px">NOLLAA KAIKKI</button>
</div>

<script>
    // DATASET
    let state = JSON.parse(localStorage.getItem('vamm_state')) || { active: false, start: 0, log: [] };
    let archive = JSON.parse(localStorage.getItem('vamm_arch')) || [];

    function save() {
        localStorage.setItem('vamm_state', JSON.stringify(state));
        localStorage.setItem('vamm_arch', JSON.stringify(archive));
    }

    function toggleShift() {
        if (!state.active) {
            let t = prompt("Aloitusaika (HH:MM):", new Date().toLocaleTimeString('fi-FI',{hour:'2-digit',minute:'2-digit'}));
            if(!t) return;
            const [h, m] = t.split(':');
            const d = new Date(); d.setHours(h, m, 0, 0);
            state.start = d.getTime();
            state.active = true;
            state.log = [];
            // Äänimerkki alussa
            try { const a = new AudioContext(); const o = a.createOscillator(); o.connect(a.destination); o.start(); o.stop(a.currentTime+0.2); } catch(e){}
        } else {
            if(confirm("Lopetetaanko vuoro?")) {
                state.log.forEach(i => archive.push(i));
                state.active = false;
                state.start = 0;
            }
        }
        save();
        updateUI();
    }

    // KELLO - TÄMÄ ON SE MOOTTORI
    function updateClock() {
        if (state.active && state.start > 0) {
            const nyt = Date.now();
            const erotus = nyt - state.start;
            
            // Lasketaan aika
            const tunnit = Math.floor(erotus / 3600000);
            const minuutit = Math.floor((erotus % 3600000) / 60000);
            const sekunnit = Math.floor((erotus % 60000) / 1000);
            
            document.getElementById('clockDisplay').innerText = 
                (tunnit < 10 ? "0"+tunnit : tunnit) + ":" + 
                (minuutit < 10 ? "0"+minuutit : minuutit) + ":" + 
                (sekunnit < 10 ? "0"+sekunnit : sekunnit);

            // EFF laskenta
            const tyomin = state.log.reduce((a, b) => a + (Number(b.s)+Number(b.t)+Number(b.m)), 0);
            const kulunumin = erotus / 60000;
            document.getElementById('effVal').innerText = kulunumin > 1 ? (tyomin / kulunumin).toFixed(2) : "0.00";
            document.getElementById('minVal').innerText = Math.round(tyomin);
        } else {
            document.getElementById('clockDisplay').innerText = "00:00:00";
        }
    }

    // Päivitys kerran sekunnissa, riippumatta muusta
    setInterval(updateClock, 1000);

    function updateUI() {
        const btn = document.getElementById('mainBtn');
        const area = document.getElementById('inputArea');
        if (state.active) {
            btn.innerText = "LOPETA VUORO";
            btn.className = "btn-main btn-stop";
            area.style.display = "block";
        } else {
            btn.innerText = "ALOITA VUORO";
            btn.className = "btn-main btn-start";
            area.style.display = "none";
        }
        renderLog();
    }

    function checkAuto() {
        const id = document.getElementById('in_id').value;
        const laji = document.getElementById('in_laji').value;
        const s = document.getElementById('in_s').value;
        const t = document.getElementById('in_t').value;
        const m = document.getElementById('in_m').value || 0;

        if (id.length > 3 && laji && s !== "" && t !== "") {
            state.log.push({ id, laji, s:Number(s), t:Number(t), m:Number(m) });
            document.getElementById('in_id').value = "";
            document.getElementById('in_laji').value = "";
            document.getElementById('in_s').value = "";
            document.getElementById('in_t').value = "";
            document.getElementById('in_m').value = "";
            save();
            renderLog();
        }
    }

    function renderLog() {
        const list = document.getElementById('logList');
        list.innerHTML = "";
        state.log.slice().reverse().forEach((i, idx) => {
            list.innerHTML += `<div class="history-row" onclick="editRow(${state.log.length-1-idx})">
                <b>#${i.id}</b> <span>${i.laji}</span> <b>${(i.s+i.t+i.m)} min</b>
            </div>`;
        });
    }

    function editRow(idx) {
        const n = prompt("Korjaa minuuteiksi:", (state.log[idx].s + state.log[idx].t + state.log[idx].m));
        if (n) { state.log[idx].s = Number(n); state.log[idx].t = 0; state.log[idx].m = 0; save(); renderLog(); }
    }

    function resetAll() {
        if(confirm("Haluatko varmasti nollata koko jakson historian")) {
            localStorage.clear();
            location.reload();
        }
    }

    function openArchive() { document.getElementById('archiveModal').style.display='block'; }
    function closeArchive() { document.getElementById('archiveModal').style.display='none'; }

    // Init
    updateUI();
    updateClock();
</script>
</body>
</html>
