<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ty√∂aikakirjaus v2.2.2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        #app-container { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); width: 100%; max-width: 450px; }
        .version { color: #ff0000; font-weight: bold; font-size: 12px; }
        h2 { color: #1a73e8; margin-top: 10px; }
        .input-group { margin: 15px 0; }
        input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        #scan-btn { background: #28a745; color: white; }
        #reset-btn { background: #dc3545; color: white; margin-top: 30px; }
        #interactive { width: 100%; height: 250px; background: #000; display: none; border-radius: 8px; margin-top: 10px; }
        video { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

<div id="app-container">
    <div class="version">v2.2.2</div>
    <h2>Ty√∂aika & Tehokkuus</h2>

    <div id="interactive"></div>

    <div class="input-group">
        <label>Ty√∂kortin ID:</label>
        <input type="text" id="work-card-id" oninput="autoSave()">
    </div>

    <button id="scan-btn" onclick="toggleScanner()">üì∑ AVAA / SULJE SKANNERI</button>

    <div class="input-group">
        <label>Yksik√∂t valmiina:</label>
        <input type="number" id="units" oninput="autoSave()">
    </div>

    <button id="reset-btn" onclick="handleReset()">Nollaa koko historia</button>
</div>

<script>
    let scannerIsRunning = false;

    // 1. Ty√∂vuoron aloitus√§√§ni & tietojen lataus
    window.onload = () => {
        playStartSound();
        const saved = localStorage.getItem('tyoData');
        if (saved) {
            const data = JSON.parse(saved);
            document.getElementById('work-card-id').value = data.id || '';
            document.getElementById('units').value = data.units || '';
        }
    };

    function playStartSound() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        osc.connect(ctx.destination);
        osc.frequency.value = 600;
        osc.start();
        osc.stop(ctx.currentTime + 0.3);
    }

    // 2. Skannerin ohjaus
    function toggleScanner() {
        const div = document.getElementById('interactive');
        if (scannerIsRunning) {
            Quagga.stop();
            div.style.display = 'none';
            scannerIsRunning = false;
        } else {
            div.style.display = 'block';
            startQuagga();
        }
    }

    function startQuagga() {
        Quagga.init({
            inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#interactive'), constraints: { facingMode: "environment" } },
            decoder: { readers: ["code_128_reader", "ean_reader"] }
        }, (err) => {
            if (err) { alert("Kameravirhe: " + err); return; }
            Quagga.start();
            scannerIsRunning = true;
        });

        Quagga.onDetected((res) => {
            document.getElementById('work-card-id').value = res.codeResult.code;
            autoSave();
            toggleScanner();
            alert("Koodi skannattu!");
        });
    }

    // 3. Tallennus ja Nollaus
    function autoSave() {
        const data = {
            id: document.getElementById('work-card-id').value,
            units: document.getElementById('units').value
        };
        localStorage.setItem('tyoData', JSON.stringify(data));
    }

    function handleReset() {
        if (confirm("Haluatko varmasti nollata koko jakson historian?")) {
            localStorage.removeItem('tyoData');
            location.reload();
        }
    }
</script>

</body>
</html>
